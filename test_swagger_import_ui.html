<!DOCTYPE html>
<html>
<head>
    <title>Test Swagger Import UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<div class="container mt-4">
    <h2>Test Swagger Import UI</h2>
    <button class="btn btn-primary" onclick="openSwaggerImportModal()">
        <i class="fas fa-upload me-2"></i>Import Swagger/OpenAPI
    </button>
    
    <div class="mt-3">
        <h5>Console Output:</h5>
        <div id="console-output" class="border p-3 bg-light" style="height: 300px; overflow-y: auto;"></div>
    </div>
</div>

<!-- Swagger Import Modal -->
<div class="modal fade" id="swaggerImportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Swagger/OpenAPI</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="swaggerImportSteps">
                    <!-- Step 1: File Selection -->
                    <div id="step1" class="import-step">
                        <h6>Step 1: Select Swagger File</h6>
                        <div class="mb-3">
                            <label class="form-label">Upload Swagger/OpenAPI File (JSON or YAML)</label>
                            <input type="file" class="form-control" id="swaggerFile" accept=".json,.yaml,.yml" onchange="handleFileSelect()">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Or select from existing files:</label>
                            <select class="form-control" id="existingSwaggerFiles" onchange="handleExistingFileSelect()">
                                <option value="">Select existing file...</option>
                            </select>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            This will parse the Swagger file and extract field definitions for import.
                        </div>
                    </div>

                    <!-- Step 2: Class Configuration -->
                    <div id="step2" class="import-step d-none">
                        <h6>Step 2: Configure Field Class</h6>
                        <div class="mb-3">
                            <label class="form-label">Field Class Name</label>
                            <input type="text" class="form-control" id="importClassName" placeholder="Enter class name" required>
                            <small class="form-text text-muted">This will be the main field class created from the API definition.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cleanupExisting">
                                <label class="form-check-label" for="cleanupExisting">
                                    Clean up existing class and fields with same name
                                </label>
                                <small class="form-text text-muted d-block">If checked, any existing class with the same name will be deleted along with its fields.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Preview -->
                    <div id="step3" class="import-step d-none">
                        <h6>Step 3: Preview Import</h6>
                        <div class="mb-3">
                            <strong>API Information:</strong>
                            <div id="apiInfo" class="border p-2 mt-2 bg-light"></div>
                        </div>
                        <div class="mb-3">
                            <strong>Field Classes to be Created:</strong>
                            <div id="fieldClassesPreview" class="border p-2 mt-2 bg-light"></div>
                        </div>
                        <div class="mb-3">
                            <strong>Input Fields to be Created:</strong>
                            <div id="inputFieldsPreview" class="border p-2 mt-2 bg-light" style="max-height: 200px; overflow-y: auto;"></div>
                        </div>
                        <div class="mb-3">
                            <strong>Output Fields to be Created:</strong>
                            <div id="outputFieldsPreview" class="border p-2 mt-2 bg-light" style="max-height: 200px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-secondary" id="prevStepBtn" onclick="previousStep()" style="display: none;">Previous</button>
                <button type="button" class="btn btn-primary" id="nextStepBtn" onclick="nextStep()" disabled>Next</button>
                <button type="button" class="btn btn-success" id="importBtn" onclick="performImport()" style="display: none;">
                    <i class="fas fa-download me-2"></i>Import
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Test variables
    let swaggerImportModal = null;
    let currentImportStep = 1;
    let parsedSwaggerData = null;
    
    // Console logging
    function logToConsole(message) {
        const consoleOutput = document.getElementById('console-output');
        const time = new Date().toLocaleTimeString();
        consoleOutput.innerHTML += `[${time}] ${message}<br>`;
        consoleOutput.scrollTop = consoleOutput.scrollHeight;
        console.log(message);
    }
    
    // Initialize modal when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        logToConsole('DOM loaded, initializing modal...');
        const swaggerModalElement = document.getElementById('swaggerImportModal');
        if (swaggerModalElement) {
            if (typeof bootstrap !== 'undefined') {
                swaggerImportModal = new bootstrap.Modal(swaggerModalElement);
                logToConsole('Swagger modal initialized successfully');
            } else {
                logToConsole('ERROR: Bootstrap not available');
            }
        } else {
            logToConsole('ERROR: Swagger modal element not found');
        }
        
        // Load existing files
        loadExistingSwaggerFiles();
    });
    
    function openSwaggerImportModal() {
        logToConsole('openSwaggerImportModal called');
        
        if (!swaggerImportModal) {
            logToConsole('Modal not initialized, trying to initialize...');
            const swaggerModalElement = document.getElementById('swaggerImportModal');
            if (swaggerModalElement && typeof bootstrap !== 'undefined') {
                swaggerImportModal = new bootstrap.Modal(swaggerModalElement);
                logToConsole('Modal initialized');
            } else {
                logToConsole('ERROR: Cannot initialize modal');
                return;
            }
        }
        
        currentImportStep = 1;
        showImportStep(1);
        
        // Reset form state
        const fileInput = document.getElementById('swaggerFile');
        const existingFileSelect = document.getElementById('existingSwaggerFiles');
        const nextBtn = document.getElementById('nextStepBtn');
        
        if (fileInput) fileInput.value = '';
        if (existingFileSelect) existingFileSelect.value = '';
        if (nextBtn) nextBtn.disabled = true;
        
        logToConsole('Showing modal...');
        swaggerImportModal.show();
    }
    
    function showImportStep(step) {
        logToConsole(`showImportStep called with step: ${step}`);
        
        // Hide all steps
        for (let i = 1; i <= 3; i++) {
            const stepDiv = document.getElementById(`step${i}`);
            if (stepDiv) {
                stepDiv.classList.add('d-none');
                logToConsole(`Hiding step${i}`);
            }
        }
        
        // Show current step
        const currentStepDiv = document.getElementById(`step${step}`);
        if (currentStepDiv) {
            currentStepDiv.classList.remove('d-none');
            logToConsole(`Showing step${step}`);
        } else {
            logToConsole(`ERROR: step${step} element not found`);
        }
        
        // Update button visibility and state
        updateStepButtons(step);
        
        currentImportStep = step;
        logToConsole(`Current step set to: ${currentImportStep}`);
    }
    
    function updateStepButtons(step) {
        logToConsole(`updateStepButtons called with step: ${step}`);
        
        const prevBtn = document.getElementById('prevStepBtn');
        const nextBtn = document.getElementById('nextStepBtn');
        const importBtn = document.getElementById('importBtn');
        
        // Reset all buttons
        if (prevBtn) {
            prevBtn.style.display = step > 1 ? 'inline-block' : 'none';
            logToConsole(`Previous button display: ${prevBtn.style.display}`);
        }
        
        if (nextBtn) {
            nextBtn.style.display = step < 3 ? 'inline-block' : 'none';
            nextBtn.disabled = step === 1; // Disabled on step 1 until file is selected
            nextBtn.innerHTML = step === 2 ? 'Review' : 'Next';
            logToConsole(`Next button display: ${nextBtn.style.display}, disabled: ${nextBtn.disabled}, text: ${nextBtn.innerHTML}`);
        }
        
        if (importBtn) {
            importBtn.style.display = step === 3 ? 'inline-block' : 'none';
            logToConsole(`Import button display: ${importBtn.style.display}`);
        }
    }
    
    function handleFileSelect() {
        logToConsole('handleFileSelect called');
        const fileInput = document.getElementById('swaggerFile');
        const nextBtn = document.getElementById('nextStepBtn');
        
        if (fileInput && fileInput.files.length > 0) {
            logToConsole(`File selected: ${fileInput.files[0].name}`);
            if (nextBtn) {
                nextBtn.disabled = false;
                logToConsole('Next button enabled');
            }
            // Clear existing file selection
            const existingFileSelect = document.getElementById('existingSwaggerFiles');
            if (existingFileSelect) {
                existingFileSelect.value = '';
            }
        } else {
            logToConsole('No file selected');
            if (nextBtn) {
                nextBtn.disabled = true;
            }
        }
    }
    
    function handleExistingFileSelect() {
        logToConsole('handleExistingFileSelect called');
        const existingFileSelect = document.getElementById('existingSwaggerFiles');
        const nextBtn = document.getElementById('nextStepBtn');
        
        if (existingFileSelect && existingFileSelect.value !== '') {
            logToConsole(`Existing file selected: ${existingFileSelect.value}`);
            if (nextBtn) {
                nextBtn.disabled = false;
                logToConsole('Next button enabled for existing file');
            }
            // Clear file input
            const fileInput = document.getElementById('swaggerFile');
            if (fileInput) {
                fileInput.value = '';
            }
        } else {
            logToConsole('No existing file selected');
            if (nextBtn) {
                nextBtn.disabled = true;
            }
        }
    }
    
    function nextStep() {
        logToConsole(`nextStep called, current step: ${currentImportStep}`);
        
        if (currentImportStep === 1) {
            // Simulate successful parsing
            parsedSwaggerData = {
                api_info: {
                    title: "Test API",
                    description: "Test API Description",
                    version: "1.0.0"
                },
                suggested_class_name: "TestAPI"
            };
            populateSwaggerPreview(parsedSwaggerData);
            showImportStep(2);
        } else if (currentImportStep === 2) {
            showImportStep(3);
        }
    }
    
    function previousStep() {
        logToConsole(`previousStep called, current step: ${currentImportStep}`);
        if (currentImportStep > 1) {
            showImportStep(currentImportStep - 1);
        }
    }
    
    function performImport() {
        logToConsole('performImport called - would execute import here');
    }
    
    function populateSwaggerPreview(data) {
        logToConsole('populateSwaggerPreview called');
        
        // Populate API info
        const apiInfoDiv = document.getElementById('apiInfo');
        if (apiInfoDiv) {
            apiInfoDiv.innerHTML = `
                <div><strong>Title:</strong> ${data.api_info.title}</div>
                <div><strong>Description:</strong> ${data.api_info.description}</div>
                <div><strong>Version:</strong> ${data.api_info.version}</div>
            `;
            logToConsole('API info populated');
        }
        
        // Set suggested class name
        const classNameInput = document.getElementById('importClassName');
        if (classNameInput) {
            classNameInput.value = data.suggested_class_name;
            logToConsole('Class name set to: ' + data.suggested_class_name);
        }
    }
    
    function loadExistingSwaggerFiles() {
        logToConsole('loadExistingSwaggerFiles called - simulating file list');
        const fileSelect = document.getElementById('existingSwaggerFiles');
        if (fileSelect) {
            fileSelect.innerHTML = '<option value="">Select existing file...</option>';
            
            // Add test files
            const testFiles = [
                'US_Sales_Tax_Calculator_API.json',
                'Currency_Exchange_Rate_API.json',
                'Shipping_Cost_Calculator_API.json'
            ];
            
            testFiles.forEach(fileName => {
                const option = document.createElement('option');
                option.value = `temp/${fileName}`;
                option.textContent = fileName;
                fileSelect.appendChild(option);
            });
            
            logToConsole('Test files added to dropdown');
        }
    }
</script>
</body>
</html>