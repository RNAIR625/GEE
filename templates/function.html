{% extends "base.html" %}

{% block title %}Function Management{% endblock %}

{% block additional_styles %}
<style>
.table thead th {
    background-color: #8BC34A;
    color: white;
    font-weight: 500;
}

.action-buttons .btn {
    padding: 5px 10px;
    margin: 0 2px;
}

.function-table {
    margin-bottom: 2rem;
}

.params-table {
    margin-top: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <!-- Function Section -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="card-title mb-0">Functions</h4>
            <button class="btn btn-primary" onclick="openNewFunctionModal()">
                <i class="fas fa-plus me-2"></i>New Function
            </button>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Function Name</th>
                        <th>Parameter Count</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="functionTableBody"></tbody>
            </table>
        </div>

        <!-- Parameters Section -->
        <div id="parametersSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
                <h5 class="mb-0">Parameters for: <span id="currentFunctionName"></span></h5>
                <button class="btn btn-primary" onclick="openNewParameterModal()">
                    <i class="fas fa-plus me-2"></i>New Parameter
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Parameter Name</th>
                            <th>Type</th>
                            <th>Sequence</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paramTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Function Modal -->
<div class="modal fade" id="functionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add New Function</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="functionForm">
                    <input type="hidden" id="gbfId">
                    <div class="mb-3">
                        <label class="form-label">Function Name</label>
                        <input type="text" class="form-control" id="functionName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="functionDescription"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveFunction()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Parameter Modal -->
<div class="modal fade" id="paramModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paramModalTitle">Add Parameter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="paramForm">
                    <input type="hidden" id="gbfpId">
                    <div class="mb-3">
                        <label class="form-label">Parameter Name</label>
                        <input type="text" class="form-control" id="paramName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Parameter Type</label>
                        <select class="form-control" id="paramType" required>
                            <option value="VARCHAR">VARCHAR</option>
                            <option value="INTEGER">INTEGER</option>
                            <option value="DECIMAL">DECIMAL</option>
                            <option value="DATE">DATE</option>
                            <option value="DATETIME">DATETIME</option>
                            <option value="BOOLEAN">BOOLEAN</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sequence</label>
                        <input type="number" class="form-control" id="paramSequence" required min="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="paramDescription"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveParameter()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this item?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentFunction = null;
    let currentDeleteId = null;
    let currentDeleteType = null;
    
    const functionModal = new bootstrap.Modal(document.getElementById('functionModal'));
    const paramModal = new bootstrap.Modal(document.getElementById('paramModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

    // Load functions when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Loading functions...');
        loadFunctions();
    });

    function loadFunctions() {
        console.log('Fetching functions...');
        fetch('/get_functions')
            .then(response => {
                console.log('Response received:', response);
                return response.json();
            })
            .then(data => {
                console.log('Functions data:', data);
                const tableBody = document.getElementById('functionTableBody');
                tableBody.innerHTML = '';
                
                data.forEach(func => {
                    const row = `
                        <tr>
                            <td>${func.FUNC_NAME}</td>
                            <td>${func.PARAM_COUNT || 0}</td>
                            <td>${func.DESCRIPTION || ''}</td>
                            <td class="action-buttons">
                                <button class="btn btn-warning btn-sm me-1" onclick="editFunction(${func.GBF_ID})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-info btn-sm me-1" onclick="viewParameters(${func.GBF_ID}, '${func.FUNC_NAME}')">
                                    <i class="fas fa-list"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="showDeleteConfirm(${func.GBF_ID}, 'function')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            })
            .catch(error => {
                console.error('Error loading functions:', error);
                alert('Error loading functions. Please check the console for details.');
            });
    }

    function viewParameters(gbfId, funcName) {
        currentFunction = { GBF_ID: gbfId, FUNC_NAME: funcName };
        document.getElementById('currentFunctionName').textContent = funcName;
        document.getElementById('parametersSection').style.display = 'block';
        loadParameters(gbfId);
    }

    function loadParameters(gbfId) {
        fetch(`/get_function_params/${gbfId}`)
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('paramTableBody');
                tableBody.innerHTML = '';
                
                data.forEach(param => {
                    const row = `
                        <tr>
                            <td>${param.PARAM_NAME}</td>
                            <td>${param.PARAM_TYPE}</td>
                            <td>${param.GBF_SEQ}</td>
                            <td>${param.DESCRIPTION || ''}</td>
                            <td class="action-buttons">
                                <button class="btn btn-warning btn-sm me-1" onclick="editParameter(${param.GBFP_ID})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="showDeleteConfirm(${param.GBFP_ID}, 'parameter')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            })
            .catch(error => {
                console.error('Error loading parameters:', error);
                alert('Error loading parameters. Please check the console for details.');
            });
    }

    function openNewFunctionModal() {
        document.getElementById('modalTitle').textContent = 'Add New Function';
        document.getElementById('functionForm').reset();
        document.getElementById('gbfId').value = '';
        currentFunction = null;
        functionModal.show();
    }

    function editFunction(gbfId) {
        fetch(`/get_functions`)
            .then(response => response.json())
            .then(data => {
                const func = data.find(f => f.GBF_ID === gbfId);
                if (func) {
                    document.getElementById('modalTitle').textContent = 'Edit Function';
                    document.getElementById('gbfId').value = func.GBF_ID;
                    document.getElementById('functionName').value = func.FUNC_NAME;
                    document.getElementById('functionDescription').value = func.DESCRIPTION || '';
                    currentFunction = func;
                    functionModal.show();
                }
            });
    }

    function saveFunction() {
        const gbfId = document.getElementById('gbfId').value;
        const data = {
            funcName: document.getElementById('functionName').value,
            description: document.getElementById('functionDescription').value
        };

        if (!data.funcName) {
            alert('Function Name is required!');
            return;
        }

        const method = gbfId ? 'PUT' : 'POST';
        const url = gbfId ? '/update_function' : '/add_function';
        if (gbfId) data.gbfId = gbfId;

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                functionModal.hide();
                loadFunctions();
                alert(result.message);
            } else {
                alert('Error: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Error saving function:', error);
            alert('Error saving function. Please check the console for details.');
        });
    }

    function openNewParameterModal() {
        if (!currentFunction) {
            alert('Please select a function first');
            return;
        }
        document.getElementById('paramModalTitle').textContent = 'Add Parameter';
        document.getElementById('paramForm').reset();
        document.getElementById('gbfpId').value = '';
        paramModal.show();
    }

    function editParameter(gbfpId) {
        fetch(`/get_function_params/${currentFunction.GBF_ID}`)
            .then(response => response.json())
            .then(data => {
                const param = data.find(p => p.GBFP_ID === gbfpId);
                if (param) {
                    document.getElementById('paramModalTitle').textContent = 'Edit Parameter';
                    document.getElementById('gbfpId').value = param.GBFP_ID;
                    document.getElementById('paramName').value = param.PARAM_NAME;
                    document.getElementById('paramType').value = param.PARAM_TYPE;
                    document.getElementById('paramSequence').value = param.GBF_SEQ;
                    document.getElementById('paramDescription').value = param.DESCRIPTION || '';
                    paramModal.show();
                }
            });
    }

    function saveParameter() {
        const gbfpId = document.getElementById('gbfpId').value;
        const data = {
            gbfId: currentFunction.GBF_ID,
            paramName: document.getElementById('paramName').value,
            paramType: document.getElementById('paramType').value,
            sequence: parseInt(document.getElementById('paramSequence').value),
            description: document.getElementById('paramDescription').value
        };

        if (!data.paramName || !data.paramType) {
            alert('Parameter Name and Type are required!');
            return;
        }

        const method = gbfpId ? 'PUT' : 'POST';
        const url = gbfpId ? '/update_param' : '/add_param';
        if (gbfpId) data.gbfpId = gbfpId;

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                paramModal.hide();
                loadParameters(currentFunction.GBF_ID);
                loadFunctions(); // Refresh to update parameter count
                alert(result.message);
            } else {
                alert('Error: ' + result.message);
            }
        });
    }

    function showDeleteConfirm(id, type) {
        currentDeleteId = id;
        currentDeleteType = type;
        deleteModal.show();
    }

    function confirmDelete() {
        if (!currentDeleteId || !currentDeleteType) return;
        

        const url = currentDeleteType === 'function' 
            ? `/delete_function/${currentDeleteId}`
            : `/delete_param/${currentDeleteId}`;

        fetch(url, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                deleteModal.hide();
                if (currentDeleteType === 'function') {
                    loadFunctions();
                    document.getElementById('parametersSection').style.display = 'none';
                    currentFunction = null;
                } else {
                    loadParameters(currentFunction.GBF_ID);
                    loadFunctions(); // Refresh to update parameter count
                }
                alert(result.message);
            } else {
                alert('Error: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Error deleting item:', error);
            alert('Error deleting item. Please check the console for details.');
        });
    }
</script>
{% endblock %}        