{% extends "base.html" %}

{% block title %}Function Management{% endblock %}

{% block additional_styles %}
.table thead th {
    background-color: #4dabf7;
    color: white;
    font-weight: 500;
}

.function-table {
    margin-bottom: 30px;
}

.parameter-section {
    margin-top: 30px;
    border-top: 1px solid #dee2e6;
    padding-top: 20px;
}

.parameter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.btn-icon {
    padding: 5px 10px;
    margin: 0 2px;
}

.hidden {
    display: none;
}

.selected-function {
    background-color: #e9ecef;
}
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="card-title mb-0">Functions</h4>
            <button class="btn btn-primary" onclick="openNewFunctionModal()">
                <i class="fas fa-plus me-2"></i>New Function
            </button>
        </div>
        
        <div class="table-responsive function-table">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Function Name</th>
                        <th>Parameter Count</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="functionTableBody"></tbody>
            </table>
        </div>

        <div class="parameter-section" id="parameterSection">
            <div class="parameter-header">
                <h5 id="selectedFunctionHeader">Parameters for: <span id="selectedFunctionName"></span></h5>
                <button class="btn btn-primary" id="addParameterBtn" onclick="openNewParamModal()">
                    <i class="fas fa-plus me-2"></i>New Parameter
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Parameter Name</th>
                            <th>Type</th>
                            <th>Sequence</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="parameterTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Function Modal -->
<div class="modal fade" id="functionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="functionModalTitle">Add New Function</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="functionForm">
                    <input type="hidden" id="gbfId">
                    <div class="mb-3">
                        <label class="form-label">Function Name</label>
                        <input type="text" class="form-control" id="funcName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="funcDescription"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveFunction()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Parameter Modal -->
<div class="modal fade" id="parameterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="parameterModalTitle">Add New Parameter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="parameterForm">
                    <input type="hidden" id="gbfpId">
                    <input type="hidden" id="paramFunctionId">
                    <div class="mb-3">
                        <label class="form-label">Parameter Name</label>
                        <input type="text" class="form-control" id="paramName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <select class="form-control" id="paramType" required>
                            <option value="VARCHAR">VARCHAR</option>
                            <option value="INTEGER">INTEGER</option>
                            <option value="DECIMAL">DECIMAL</option>
                            <option value="DATE">DATE</option>
                            <option value="DATETIME">DATETIME</option>
                            <option value="BOOLEAN">BOOLEAN</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sequence</label>
                        <input type="number" class="form-control" id="paramSequence" min="1" value="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="paramDescription"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveParameter()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalTitle">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="deleteModalBody">
                Are you sure you want to delete this item?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Variables for managing state
    let currentFunctionId = null;
    let deleteType = ''; // 'function' or 'parameter'
    let deleteId = null;

    // Modals
    const functionModal = new bootstrap.Modal(document.getElementById('functionModal'));
    const parameterModal = new bootstrap.Modal(document.getElementById('parameterModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadFunctions();
        document.getElementById('parameterSection').classList.add('hidden');
        
        // Set up delete confirmation handler
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (deleteType === 'function') {
                deleteFunction(deleteId);
            } else if (deleteType === 'parameter') {
                deleteParameter(deleteId);
            }
        });
    });

    // Function Management
    function loadFunctions() {
        fetch('/get_functions')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('functionTableBody');
                tableBody.innerHTML = '';
                
                data.forEach(func => {
                    const row = `
                        <tr data-id="${func.GBF_ID}" class="${currentFunctionId === func.GBF_ID ? 'selected-function' : ''}">
                            <td>${func.FUNC_NAME}</td>
                            <td>${func.PARAM_COUNT || 0}</td>
                            <td>${func.DESCRIPTION || ''}</td>
                            <td>
                                <button class="btn btn-info btn-icon" onclick="viewParameters(${func.GBF_ID}, '${func.FUNC_NAME}')">
                                    <i class="fas fa-list"></i>
                                </button>
                                <button class="btn btn-warning btn-icon" onclick="editFunction(${func.GBF_ID}, '${func.FUNC_NAME}', '${func.DESCRIPTION || ''}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-icon" onclick="confirmDeleteFunction(${func.GBF_ID}, '${func.FUNC_NAME}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            });
    }

    function openNewFunctionModal() {
        document.getElementById('functionModalTitle').textContent = 'Add New Function';
        document.getElementById('functionForm').reset();
        document.getElementById('gbfId').value = '';
        functionModal.show();
    }

    function editFunction(gbfId, funcName, description) {
        document.getElementById('functionModalTitle').textContent = 'Edit Function';
        document.getElementById('gbfId').value = gbfId;
        document.getElementById('funcName').value = funcName;
        document.getElementById('funcDescription').value = description;
        functionModal.show();
    }

    function saveFunction() {
        const gbfId = document.getElementById('gbfId').value;
        const funcName = document.getElementById('funcName').value;
        const description = document.getElementById('funcDescription').value;

        if (!funcName) {
            alert('Function Name is required!');
            return;
        }

        const method = gbfId ? 'PUT' : 'POST';
        const url = gbfId ? '/update_function' : '/add_function';
        const data = {
            gbfId: gbfId,
            funcName: funcName,
            description: description
        };

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                functionModal.hide();
                loadFunctions();
                
                // If we're editing the currently selected function, reload parameters
                if (currentFunctionId === gbfId) {
                    loadParameters(currentFunctionId);
                    document.getElementById('selectedFunctionName').textContent = funcName;
                }
                
                alert(result.message);
            } else {
                alert('Error: ' + result.message);
            }
        });
    }

    function confirmDeleteFunction(gbfId, funcName) {
        deleteType = 'function';
        deleteId = gbfId;
        document.getElementById('deleteModalTitle').textContent = 'Delete Function';
        document.getElementById('deleteModalBody').textContent = `Are you sure you want to delete the function "${funcName}"? This will also delete all associated parameters.`;
        deleteModal.show();
    }

    function deleteFunction(gbfId) {
        fetch(`/delete_function/${gbfId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                deleteModal.hide();
                loadFunctions();
                
                // If we're deleting the currently selected function, hide parameter section
                if (currentFunctionId === gbfId) {
                    document.getElementById('parameterSection').classList.add('hidden');
                    currentFunctionId = null;
                }
                
                alert(data.message);
            } else {
                alert('Error: ' + data.message);
            }
        });
    }

    // Parameter Management
    function viewParameters(gbfId, funcName) {
        currentFunctionId = gbfId;
        document.getElementById('selectedFunctionName').textContent = funcName;
        document.getElementById('parameterSection').classList.remove('hidden');
        
        // Highlight the selected function row
        const rows = document.querySelectorAll('#functionTableBody tr');
        rows.forEach(row => {
            if (row.getAttribute('data-id') == gbfId) {
                row.classList.add('selected-function');
            } else {
                row.classList.remove('selected-function');
            }
        });
        
        loadParameters(gbfId);
    }

    function loadParameters(gbfId) {
        fetch(`/get_function_params/${gbfId}`)
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('parameterTableBody');
                tableBody.innerHTML = '';
                
                // Check if we received an array of parameters
                if (Array.isArray(data)) {
                    data.forEach(param => {
                        const row = `
                            <tr>
                                <td>${param.PARAM_NAME}</td>
                                <td>${param.PARAM_TYPE}</td>
                                <td>${param.GBF_SEQ}</td>
                                <td>${param.DESCRIPTION || ''}</td>
                                <td>
                                    <button class="btn btn-warning btn-icon" onclick="editParameter(${JSON.stringify(param).replace(/"/g, '&quot;')})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-icon" onclick="confirmDeleteParameter(${param.GBFP_ID}, '${param.PARAM_NAME}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                }
            });
    }

    function openNewParamModal() {
        document.getElementById('parameterModalTitle').textContent = 'Add New Parameter';
        document.getElementById('parameterForm').reset();
        document.getElementById('gbfpId').value = '';
        document.getElementById('paramFunctionId').value = currentFunctionId;
        
        // Set next sequence number based on current number of parameters
        const rows = document.querySelectorAll('#parameterTableBody tr');
        document.getElementById('paramSequence').value = rows.length + 1;
        
        parameterModal.show();
    }

    function editParameter(param) {
        document.getElementById('parameterModalTitle').textContent = 'Edit Parameter';
        document.getElementById('gbfpId').value = param.GBFP_ID;
        document.getElementById('paramFunctionId').value = param.GBF_ID;
        document.getElementById('paramName').value = param.PARAM_NAME;
        document.getElementById('paramType').value = param.PARAM_TYPE;
        document.getElementById('paramSequence').value = param.GBF_SEQ;
        document.getElementById('paramDescription').value = param.DESCRIPTION || '';
        parameterModal.show();
    }

    function saveParameter() {
        const gbfpId = document.getElementById('gbfpId').value;
        const data = {
            gbfpId: gbfpId,
            gbfId: currentFunctionId,
            paramName: document.getElementById('paramName').value,
            paramType: document.getElementById('paramType').value,
            sequence: document.getElementById('paramSequence').value,
            description: document.getElementById('paramDescription').value
        };

        if (!data.paramName || !data.paramType) {
            alert('Parameter Name and Type are required!');
            return;
        }

        const method = gbfpId ? 'PUT' : 'POST';
        const url = gbfpId ? '/update_param' : '/add_param';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                parameterModal.hide();
                loadParameters(currentFunctionId);
                loadFunctions(); // Reload functions to update parameter count
                alert(result.message);
            } else {
                alert('Error: ' + result.message);
            }
        });
    }

    function confirmDeleteParameter(gbfpId, paramName) {
        deleteType = 'parameter';
        deleteId = gbfpId;
        document.getElementById('deleteModalTitle').textContent = 'Delete Parameter';
        document.getElementById('deleteModalBody').textContent = `Are you sure you want to delete the parameter "${paramName}"?`;
        deleteModal.show();
    }

    function deleteParameter(gbfpId) {
        fetch(`/delete_param/${gbfpId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                deleteModal.hide();
                loadParameters(currentFunctionId);
                loadFunctions(); // Reload functions to update parameter count
                alert(data.message);
            } else {
                alert('Error: ' + data.message);
            }
        });
    }
</script>
{% endblock %}