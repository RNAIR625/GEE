{% extends "base.html" %}

{% block title %}Environment Configuration{% endblock %}

{% block additional_styles %}
.table thead th {
    background-color: #1abc9c;
    color: white;
    font-weight: 500;
}

.db-type-badge {
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
}

.db-type-SQLite {
    background-color: #3498db;
    color: white;
}

.db-type-Oracle {
    background-color: #e74c3c;
    color: white;
}

.db-type-Postgres {
    background-color: #2ecc71;
    color: white;
}

.connection-badge {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 500;
}

.connection-active {
    background-color: #2ecc71;
    color: white;
}

.connection-inactive {
    background-color: #95a5a6;
    color: white;
}

.password-field {
    position: relative;
}

.toggle-password {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #6c757d;
}

.required-field::after {
    content: "*";
    color: #e74c3c;
    margin-left: 4px;
}

.active-connections {
    max-height: 200px;
    overflow-y: auto;
}

.connection-item {
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 8px;
    background-color: #f8f9fa;
    border-left: 4px solid #2ecc71;
}

.connection-info {
    font-size: 0.85rem;
    color: #6c757d;
}
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Environment Configuration</h2>
        <button class="btn btn-primary" onclick="openNewConfigModal()">
            <i class="fas fa-plus me-2"></i>New Environment
        </button>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="searchConfigs" placeholder="Search environments..." onkeyup="searchConfigs()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="filterDbType" onchange="filterConfigs()">
                                <option value="">All Database Types</option>
                                <option value="SQLite">SQLite</option>
                                <option value="Oracle">Oracle</option>
                                <option value="Postgres">PostgreSQL</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Environment Name</th>
                                    <th>Database Type</th>
                                    <th>Database Name</th>
                                    <th>Instance/Host</th>
                                    <th>Connection</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="configList"></tbody>
                        </table>
                    </div>
                    <div id="noConfigsMessage" class="text-center py-4 d-none">
                        <i class="fas fa-server fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No environment configurations found. Click the "New Environment" button to create one.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Active Connections</h5>
                </div>
                <div class="card-body">
                    <div id="activeConnections" class="active-connections">
                        <!-- Active connections will be displayed here -->
                    </div>
                    <div id="noConnectionsMessage" class="text-center py-3">
                        <i class="fas fa-plug fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No active connections. Test and connect to a database to create a connection.</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Connection Status</h5>
                </div>
                <div class="card-body">
                    <div id="connectionStatus" class="text-center">
                        <i class="fas fa-info-circle fa-2x text-muted mb-2"></i>
                        <p class="text-muted">Select an environment and click "Test Connection" to view status</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Environment Config Modal -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add New Environment Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="configForm">
                    <input type="hidden" id="gtId">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required-field">Environment Name</label>
                            <input type="text" class="form-control" id="envName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required-field">Database Type</label>
                            <select class="form-select" id="dbType" required onchange="toggleDatabaseFields()">
                                <option value="">Select Database Type</option>
                                <option value="SQLite">SQLite</option>
                                <option value="Oracle">Oracle</option>
                                <option value="Postgres">PostgreSQL</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required-field">Database Name</label>
                            <input type="text" class="form-control" id="dbName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Database Instance</label>
                            <input type="text" class="form-control" id="dbInstance">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Database Password</label>
                            <div class="password-field">
                                <input type="password" class="form-control" id="dbPassword">
                                <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('dbPassword')"></i>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Port</label>
                            <input type="number" class="form-control" id="dbPort">
                        </div>
                    </div>
                    
                    <div id="linuxSection" class="border-top pt-3 mt-4">
                        <h6 class="mb-3">Linux Server Configuration (Optional)</h6>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Linux Host</label>
                                <input type="text" class="form-control" id="linuxHost">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Linux User</label>
                                <input type="text" class="form-control" id="linuxUser">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Linux Password</label>
                                <div class="password-field">
                                    <input type="password" class="form-control" id="linuxPassword">
                                    <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('linuxPassword')"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info me-2" id="testConnectionBtn" onclick="testConnection()">
                    <i class="fas fa-plug me-1"></i> Test Connection
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveConfig()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this environment configuration? This action cannot be undone.</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>Deleting this configuration will remove any associated connection handles.</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Connection Success Modal -->
<div class="modal fade" id="connectionSuccessModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Connection Successful</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Successfully connected to the database!</p>
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle me-3 fa-2x"></i>
                        <div>
                            <p class="mb-1">Connection handle created:</p>
                            <code id="connectionHandle" class="bg-light px-2 py-1 rounded d-block"></code>
                        </div>
                    </div>
                </div>
                <p>Would you like to store this connection for use in rules and workflows?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="storeConnection()">
                    <i class="fas fa-save me-1"></i> Store Connection
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize global variables
    let allConfigs = [];
    let currentDeleteId = null;
    let configModal;
    let deleteModal;
    let connectionSuccessModal;
    let currentConnectionHandle = null;
    let currentConfigId = null;
    let activeConnections = {};
    let app_runtime_id = "{{ app_runtime_id }}";

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize modals
        configModal = new bootstrap.Modal(document.getElementById('configModal'));
        deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        connectionSuccessModal = new bootstrap.Modal(document.getElementById('connectionSuccessModal'));
        
        // Load configurations and active connections
        loadConfigs();
        loadActiveConnections();
        
        // Set interval to refresh active connections every 30 seconds
        setInterval(loadActiveConnections, 30000);
    });
    
    // Toggle password visibility
    function togglePasswordVisibility(inputId) {
        const input = document.getElementById(inputId);
        const icon = input.nextElementSibling;
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }
    
    // Toggle database fields based on selected type
    function toggleDatabaseFields() {
        const dbType = document.getElementById('dbType').value;
        const dbInstanceField = document.getElementById('dbInstance');
        const dbPortField = document.getElementById('dbPort');
        
        if (dbType === 'SQLite') {
            dbInstanceField.disabled = true;
            dbInstanceField.required = false;
            dbPortField.disabled = true;
            dbPortField.required = false;
        } else {
            dbInstanceField.disabled = false;
            dbInstanceField.required = true;
            dbPortField.disabled = false;
            dbPortField.required = true;
        }
    }
    
    // Open new config modal
    function openNewConfigModal() {
        document.getElementById('modalTitle').textContent = 'Add New Environment Configuration';
        document.getElementById('configForm').reset();
        document.getElementById('gtId').value = '';
        
        // Reset connection status
        updateConnectionStatus('');
        
        // Reset current connection handle
        currentConnectionHandle = null;
        currentConfigId = null;
        
        configModal.show();
    }
    
    // Test database connection
    function testConnection() {
        const gtId = document.getElementById('gtId').value;
        const envName = document.getElementById('envName').value;
        const dbType = document.getElementById('dbType').value;
        const dbName = document.getElementById('dbName').value;
        const dbInstance = document.getElementById('dbInstance').value;
        const dbPassword = document.getElementById('dbPassword').value;
        const dbPort = document.getElementById('dbPort').value;
        const linuxUser = document.getElementById('linuxUser').value;
        const linuxPassword = document.getElementById('linuxPassword').value;
        const linuxHost = document.getElementById('linuxHost').value;
        
        if (!envName || !dbType || !dbName) {
            showToast('Error', 'Environment name, database type, and database name are required', 'error');
            return;
        }
        
        // For Oracle and Postgres, additional checks
        if ((dbType === 'Oracle' || dbType === 'Postgres') && (!dbInstance || !dbPort)) {
            showToast('Error', 'Database instance and port are required for Oracle and PostgreSQL', 'error');
            return;
        }
        
        const data = {
            gtId: gtId,
            envName: envName,
            dbType: dbType,
            dbName: dbName,
            dbInstance: dbInstance,
            dbPassword: dbPassword,
            dbPort: dbPort,
            linuxUser: linuxUser,
            linuxPassword: linuxPassword,
            linuxHost: linuxHost
        };
        
        // Show testing status
        updateConnectionStatus('<div class="d-flex align-items-center"><div class="spinner-border text-primary me-3" role="status"><span class="visually-hidden">Testing...</span></div><div>Testing connection to database...</div></div>');
        
        fetch('{{ url_for("env_config.test_connection") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Store connection handle for later use
                currentConnectionHandle = result.handle;
                currentConfigId = gtId || 'temp';
                
                // Update connection status
                updateConnectionStatus(`
                    <div class="text-center">
                        <div class="bg-success text-white p-3 rounded-3 mb-3">
                            <i class="fas fa-check-circle fa-3x mb-2"></i>
                            <h5>Connection Successful!</h5>
                        </div>
                        <p>${result.message}</p>
                        <div class="alert alert-info">
                            <p class="mb-0"><strong>Connection Handle:</strong> ${result.handle}</p>
                        </div>
                    </div>
                `);
                
                // Show connection success modal
                document.getElementById('connectionHandle').textContent = result.handle;
                connectionSuccessModal.show();
            } else {
                // Update connection status
                updateConnectionStatus(`
                    <div class="text-center">
                        <div class="bg-danger text-white p-3 rounded-3 mb-3">
                            <i class="fas fa-times-circle fa-3x mb-2"></i>
                            <h5>Connection Failed!</h5>
                        </div>
                        <p>${result.message}</p>
                    </div>
                `);
            }
        })
        .catch(error => {
            updateConnectionStatus(`
                <div class="text-center">
                    <div class="bg-danger text-white p-3 rounded-3 mb-3">
                        <i class="fas fa-exclamation-triangle fa-3x mb-2"></i>
                        <h5>Error</h5>
                    </div>
                    <p>An error occurred while testing the connection: ${error}</p>
                </div>
            `);
        });
    }
    
    // Store connection handle
    function storeConnection() {
        if (!currentConnectionHandle || !currentConfigId) {
            showToast('Error', 'No connection handle available', 'error');
            return;
        }
        
        fetch('{{ url_for("env_config.store_connection") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                handle: currentConnectionHandle,
                configId: currentConfigId,
                app_runtime_id: app_runtime_id
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showToast('Success', result.message);
                loadActiveConnections();
                connectionSuccessModal.hide();
            } else {
                showToast('Error', result.message, 'error');
            }
        })
        .catch(error => {
            showToast('Error', 'An error occurred while storing the connection', 'error');
            console.error('Error:', error);
        });
    }
    
    // Update connection status display
    function updateConnectionStatus(html) {
        const statusContainer = document.getElementById('connectionStatus');
        statusContainer.innerHTML = html;
    }
    
    // Save environment configuration
    function saveConfig() {
        const gtId = document.getElementById('gtId').value;
        const envName = document.getElementById('envName').value;
        const dbType = document.getElementById('dbType').value;
        const dbName = document.getElementById('dbName').value;
        const dbInstance = document.getElementById('dbInstance').value;
        const dbPassword = document.getElementById('dbPassword').value;
        const dbPort = document.getElementById('dbPort').value;
        const linuxUser = document.getElementById('linuxUser').value;
        const linuxPassword = document.getElementById('linuxPassword').value;
        const linuxHost = document.getElementById('linuxHost').value;
        
        if (!envName || !dbType || !dbName) {
            showToast('Error', 'Environment name, database type, and database name are required', 'error');
            return;
        }
        
        const data = {
            gtId: gtId,
            envName: envName,
            dbType: dbType,
            dbName: dbName,
            dbInstance: dbInstance,
            dbPassword: dbPassword,
            dbPort: dbPort,
            linuxUser: linuxUser,
            linuxPassword: linuxPassword,
            linuxHost: linuxHost
        };
        
        const method = gtId ? 'PUT' : 'POST';
        const url = gtId ? '{{ url_for("env_config.update_env_config") }}' : '{{ url_for("env_config.add_env_config") }}';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                configModal.hide();
                loadConfigs();
                showToast('Success', result.message);
            } else {
                showToast('Error', result.message, 'error');
            }
        })
        .catch(error => {
            showToast('Error', 'An error occurred while saving the configuration', 'error');
            console.error('Error:', error);
        });
    }
    
    // Edit environment configuration
    function editConfig(gtId) {
        console.log('Editing config ID:', gtId);
        
        const config = allConfigs.find(c => c.GT_ID === gtId);
        
        if (config) {
            document.getElementById('modalTitle').textContent = 'Edit Environment Configuration';
            document.getElementById('gtId').value = config.GT_ID;
            document.getElementById('envName').value = config.ENV_NAME;
            document.getElementById('dbType').value = config.DB_TYPE || '';
            document.getElementById('dbName').value = config.DB_NAME;
            document.getElementById('dbInstance').value = config.DB_INSTANCE || '';
            document.getElementById('dbPassword').value = config.DB_PASSWORD || '';
            document.getElementById('dbPort').value = config.DB_PORT || '';
            document.getElementById('linuxUser').value = config.LINUX_USER || '';
            document.getElementById('linuxPassword').value = config.LINUX_PASSWORD || '';
            document.getElementById('linuxHost').value = config.LINUX_HOST || '';
            
            // Reset connection status
            updateConnectionStatus('');
            
            // Update current config ID for connection testing
            currentConfigId = gtId;
            currentConnectionHandle = null;
            
            // Toggle database fields based on selected type
            toggleDatabaseFields();
            
            configModal.show();
        } else {
            showToast('Error', 'Configuration not found', 'error');
        }
    }
    
    // Delete environment configuration
    function deleteConfig(gtId) {
        currentDeleteId = gtId;
        deleteModal.show();
    }
    
    // Confirm delete
    function confirmDelete() {
        if (!currentDeleteId) return;
        
        fetch(`{{ url_for("env_config.delete_env_config", gt_id=0) }}`.replace('0', currentDeleteId), {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                deleteModal.hide();
                loadConfigs();
                showToast('Success', data.message);
            } else {
                showToast('Error', data.message, 'error');
            }
        })
        .catch(error => {
            showToast('Error', 'An error occurred while deleting the configuration', 'error');
            console.error('Error:', error);
        });
    }
    
    // Search configurations
    function searchConfigs() {
        const searchTerm = document.getElementById('searchConfigs').value.toLowerCase();
        const dbType = document.getElementById('filterDbType').value;
        
        let filteredConfigs = allConfigs;
        
        // Apply search filter
        if (searchTerm) {
            filteredConfigs = filteredConfigs.filter(config => 
                config.ENV_NAME.toLowerCase().includes(searchTerm) || 
                config.DB_NAME.toLowerCase().includes(searchTerm) ||
                (config.DB_INSTANCE && config.DB_INSTANCE.toLowerCase().includes(searchTerm))
            );
        }
        
        // Apply database type filter
        if (dbType) {
            filteredConfigs = filteredConfigs.filter(config => config.DB_TYPE === dbType);
        }
        
        renderConfigs(filteredConfigs);
    }
    
    // Filter configurations
    function filterConfigs() {
        // Reuse search function as it handles both search and filter
        searchConfigs();
    }
    
    // Load all configurations
    function loadConfigs() {
        console.log('Loading configurations...');
        
        fetch('{{ url_for("env_config.get_env_configs") }}')
            .then(response => {
                console.log('Response received:', response);
                return response.json();
            })
            .then(data => {
                console.log('Data received:', data);
                allConfigs = data;
                renderConfigs(data);
            })
            .catch(error => {
                console.error('Error loading configurations:', error);
                showToast('Error', 'Failed to load configurations', 'error');
            });
    }
    
    // Load active connections
    function loadActiveConnections() {
        fetch('{{ url_for("env_config.get_active_connections") }}?app_runtime_id=' + app_runtime_id)
            .then(response => response.json())
            .then(data => {
                activeConnections = data;
                renderActiveConnections(data);
            })
            .catch(error => {
                console.error('Error loading active connections:', error);
            });
    }
    
    // Render configurations to the table
    function renderConfigs(configs) {
        const tableBody = document.getElementById('configList');
        const noConfigsMessage = document.getElementById('noConfigsMessage');
        
        tableBody.innerHTML = '';
        
        if (configs.length === 0) {
            noConfigsMessage.classList.remove('d-none');
            return;
        }
        
        noConfigsMessage.classList.add('d-none');
        
        configs.forEach(config => {
            const typeClass = `db-type-${config.DB_TYPE || 'Unknown'}`;
            
            // Check if this config has an active connection
            const isConnected = Object.values(activeConnections).some(conn => conn.config_id == config.GT_ID);
            const connectionStatus = isConnected ? 
                '<span class="connection-badge connection-active">Connected</span>' : 
                '<span class="connection-badge connection-inactive">Not Connected</span>';
            
            const row = `
                <tr data-id="${config.GT_ID}">
                    <td class="fw-medium">${config.ENV_NAME}</td>
                    <td>
                        <span class="db-type-badge ${typeClass}">
                            ${config.DB_TYPE || 'Unknown'}
                        </span>
                    </td>
                    <td>${config.DB_NAME}</td>
                    <td>${config.DB_INSTANCE || '-'}</td>
                    <td>${connectionStatus}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-info btn-sm" onclick="testConfigConnection(${config.GT_ID})">
                                <i class="fas fa-plug"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="editConfig(${config.GT_ID})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteConfig(${config.GT_ID})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            
            tableBody.innerHTML += row;
        });
    }
    
    // Render active connections
    function renderActiveConnections(connections) {
        const container = document.getElementById('activeConnections');
        const noConnectionsMessage = document.getElementById('noConnectionsMessage');
        
        container.innerHTML = '';
        
        if (Object.keys(connections).length === 0) {
            noConnectionsMessage.classList.remove('d-none');
            return;
        }
        
        noConnectionsMessage.classList.add('d-none');
        
        for (const [handle, details] of Object.entries(connections)) {
            const configName = getConfigNameById(details.config_id);
            
            container.innerHTML += `
                <div class="connection-item">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>${configName || 'Unknown Environment'}</strong>
                            <div class="connection-info">
                                <span><i class="fas fa-key me-1"></i> ${handle}</span>
                            </div>
                        </div>
                        <div>
                            <span class="connection-badge connection-active">Active</span>
                        </div>
                    </div>
                    <div class="connection-info mt-2">
                        <span><i class="far fa-clock me-1"></i> Created: ${details.created}</span>
                    </div>
                </div>
            `;
        }
    }
    
    // Get configuration name by ID
    function getConfigNameById(id) {
        const config = allConfigs.find(c => c.GT_ID == id);
        return config ? config.ENV_NAME : null;
    }
    
    // Test connection for an existing configuration
    function testConfigConnection(gtId) {
        const config = allConfigs.find(c => c.GT_ID === gtId);
        
        if (!config) {
            showToast('Error', 'Configuration not found', 'error');
            return;
        }
        
        // Store the ID for later use
        currentConfigId = gtId;
        currentConnectionHandle = null;
        
        // Build data object for testing
        const data = {
            gtId: gtId,
            envName: config.ENV_NAME,
            dbType: config.DB_TYPE,
            dbName: config.DB_NAME,
            dbInstance: config.DB_INSTANCE,
            dbPassword: config.DB_PASSWORD,
            dbPort: config.DB_PORT,
            linuxUser: config.LINUX_USER,
            linuxPassword: config.LINUX_PASSWORD,
            linuxHost: config.LINUX_HOST
        };
        
        // Update status in connectionStatus panel
        updateConnectionStatus(`
            <div class="d-flex align-items-center justify-content-center">
                <div class="spinner-border text-primary me-3" role="status">
                    <span class="visually-hidden">Testing...</span>
                </div>
                <div>Testing connection to ${config.ENV_NAME}...</div>
            </div>
        `);
        
        fetch('{{ url_for("env_config.test_connection") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Store connection handle for later use
                currentConnectionHandle = result.handle;
                
                // Update connection status
                updateConnectionStatus(`
                    <div class="text-center">
                        <div class="bg-success text-white p-3 rounded-3 mb-3">
                            <i class="fas fa-check-circle fa-3x mb-2"></i>
                            <h5>Connection Successful!</h5>
                        </div>
                        <p>${result.message}</p>
                        <div class="alert alert-info">
                            <p class="mb-0"><strong>Connection Handle:</strong> ${result.handle}</p>
                        </div>
                    </div>
                `);
                
                // Show connection success modal
                document.getElementById('connectionHandle').textContent = result.handle;
                connectionSuccessModal.show();
            } else {
                // Update connection status
                updateConnectionStatus(`
                    <div class="text-center">
                        <div class="bg-danger text-white p-3 rounded-3 mb-3">
                            <i class="fas fa-times-circle fa-3x mb-2"></i>
                            <h5>Connection Failed!</h5>
                        </div>
                        <p>${result.message}</p>
                    </div>
                `);
            }
        })
        .catch(error => {
            updateConnectionStatus(`
                <div class="text-center">
                    <div class="bg-danger text-white p-3 rounded-3 mb-3">
                        <i class="fas fa-exclamation-triangle fa-3x mb-2"></i>
                        <h5>Error</h5>
                    </div>
                    <p>An error occurred while testing the connection: ${error}</p>
                </div>
            `);
        });
    }
    
    // Show toast notification
    function showToast(title, message, type = 'success') {
        // Check if we have the showToast function from base.html
        if (typeof window.showToast === 'function') {
            window.showToast(title, message, type);
            return;
        }
        
        // Fallback toast implementation
        const toast = document.createElement('div');
        toast.className = `toast position-fixed top-0 end-0 m-3 bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'warning'} text-white`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="toast-header">
                <strong class="me-auto">${title}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Use Bootstrap toast if available
        if (typeof bootstrap !== 'undefined') {
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        } else {
            // Simple fallback
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
                document.body.removeChild(toast);
            }, 3000);
        }
    }
</script>
{% endblock %}