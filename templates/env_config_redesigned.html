{% extends "base.html" %}

{% block title %}Environment Configuration{% endblock %}

{% block additional_styles %}
.environment-card {
    border: 1px solid #e3e6f0;
    border-radius: 8px;
    margin-bottom: 1rem;
    background: #fff;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}

.environment-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    user-select: none;
}

.environment-header:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
}

.environment-header.collapsed {
    border-radius: 8px;
}

.environment-body {
    padding: 0;
}

.database-item {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e3e6f0;
    transition: background-color 0.2s;
}

.database-item:last-child {
    border-bottom: none;
}

.database-item:hover {
    background-color: #f8f9fc;
}

.db-type-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
}

.db-type-SQLite { background-color: #3498db; color: white; }
.db-type-Oracle { background-color: #e74c3c; color: white; }
.db-type-Postgres { background-color: #2ecc71; color: white; }
.db-type-MySQL { background-color: #f39c12; color: white; }

.connection-badge {
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 500;
}

.connection-active { background-color: #2ecc71; color: white; }
.connection-inactive { background-color: #95a5a6; color: white; }

.primary-badge {
    background-color: #ffc107;
    color: #212529;
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 0.65rem;
    font-weight: 500;
    margin-left: 0.5rem;
}

.env-type-badge {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 500;
    margin-left: 1rem;
}

.env-type-DEV { background-color: #17a2b8; color: white; }
.env-type-TEST { background-color: #ffc107; color: #212529; }
.env-type-PROD { background-color: #dc3545; color: white; }

.collapse-icon {
    transition: transform 0.3s ease;
}

.collapsed .collapse-icon {
    transform: rotate(-90deg);
}

.database-actions {
    opacity: 0;
    transition: opacity 0.2s;
}

.database-item:hover .database-actions {
    opacity: 1;
}

.add-database-btn {
    background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    transition: all 0.2s;
}

.add-database-btn:hover {
    background: linear-gradient(90deg, #218838 0%, #1fa085 100%);
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.password-field {
    position: relative;
}

.toggle-password {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #6c757d;
}

.required-field::after {
    content: "*";
    color: #e74c3c;
    margin-left: 4px;
}

.active-connections {
    max-height: 300px;
    overflow-y: auto;
}

.connection-item {
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 8px;
    background-color: #f8f9fa;
    border-left: 4px solid #2ecc71;
}

.connection-info {
    font-size: 0.85rem;
    color: #6c757d;
}

.stats-card {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.stats-number {
    font-size: 1.5rem;
    font-weight: bold;
}
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">Environment Configuration</h2>
            <p class="text-muted mb-0">Manage your database environments and configurations</p>
        </div>
        <div>
            <button class="btn btn-outline-secondary me-2" onclick="loadEnvironments()">
                <i class="fas fa-sync-alt me-2"></i>Refresh
            </button>
            <button class="btn btn-primary" onclick="openNewEnvironmentModal()">
                <i class="fas fa-plus me-2"></i>New Environment
            </button>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <!-- Statistics Card -->
            <div class="stats-card">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="stats-number" id="envCount">0</div>
                        <div>Environments</div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-number" id="dbCount">0</div>
                        <div>Databases</div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-number" id="activeConnCount">0</div>
                        <div>Active Connections</div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-number" id="lastTestedCount">0</div>
                        <div>Recently Tested</div>
                    </div>
                </div>
            </div>
            
            <!-- Search and Filter -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="searchEnvironments" 
                                       placeholder="Search environments or databases..." onkeyup="filterEnvironments()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filterEnvType" onchange="filterEnvironments()">
                                <option value="">All Environment Types</option>
                                <option value="DEV">Development</option>
                                <option value="TEST">Testing</option>
                                <option value="PROD">Production</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filterDbType" onchange="filterEnvironments()">
                                <option value="">All Database Types</option>
                                <option value="SQLite">SQLite</option>
                                <option value="Oracle">Oracle</option>
                                <option value="Postgres">PostgreSQL</option>
                                <option value="MySQL">MySQL</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Environments List -->
            <div id="environmentsList" class="mb-4">
                <!-- Dynamic content will be loaded here -->
            </div>
            
            <!-- No Environments Message -->
            <div id="noEnvironmentsMessage" class="text-center py-5 d-none">
                <i class="fas fa-database fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">No environments found</h5>
                <p class="text-muted">Click "New Environment" to create your first environment configuration.</p>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Active Connections -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-plug me-2"></i>Active Connections
                    </h5>
                </div>
                <div class="card-body">
                    <div id="activeConnections" class="active-connections">
                        <!-- Active connections will be displayed here -->
                    </div>
                    <div id="noConnectionsMessage" class="text-center py-3">
                        <i class="fas fa-plug fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No active connections. Test a database connection to create one.</p>
                    </div>
                </div>
            </div>
            
            <!-- Connection Status -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Connection Status
                    </h5>
                </div>
                <div class="card-body">
                    <div id="connectionStatus" class="text-center">
                        <i class="fas fa-info-circle fa-2x text-muted mb-2"></i>
                        <p class="text-muted">Select a database and click "Test" to view connection status</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Environment Modal -->
<div class="modal fade" id="environmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="envModalTitle">Add New Environment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="environmentForm">
                    <input type="hidden" id="envId">
                    
                    <div class="mb-3">
                        <label class="form-label required-field">Environment Name</label>
                        <input type="text" class="form-control" id="envName" required 
                               placeholder="e.g., Development, Production, Testing">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Environment Type</label>
                        <select class="form-select" id="envType">
                            <option value="DEV">Development</option>
                            <option value="TEST">Testing</option>
                            <option value="PROD">Production</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="envDescription" rows="3" 
                                  placeholder="Optional description of this environment"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEnvironment()">Save Environment</button>
            </div>
        </div>
    </div>
</div>

<!-- Database Configuration Modal -->
<div class="modal fade" id="databaseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dbModalTitle">Add Database Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="databaseForm">
                    <input type="hidden" id="dbConfigId">
                    <input type="hidden" id="selectedEnvId">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required-field">Display Name</label>
                            <input type="text" class="form-control" id="dbDisplayName" required 
                                   placeholder="e.g., Main Application DB, Reports DB">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required-field">Database Type</label>
                            <select class="form-select" id="dbType" required onchange="toggleDatabaseFields()">
                                <option value="">Select Database Type</option>
                                <option value="SQLite">SQLite</option>
                                <option value="Oracle">Oracle</option>
                                <option value="Postgres">PostgreSQL</option>
                                <option value="MySQL">MySQL</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required-field">Database Name</label>
                            <input type="text" class="form-control" id="dbName" required>
                            <small class="form-text text-muted" id="dbNameHelp">Database name or file path</small>
                        </div>
                        <div class="col-md-6" id="usernameField">
                            <label class="form-label required-field">Username</label>
                            <input type="text" class="form-control" id="dbUsername">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6" id="hostField">
                            <label class="form-label required-field">Host/Server</label>
                            <input type="text" class="form-control" id="dbHost">
                        </div>
                        <div class="col-md-6" id="portField">
                            <label class="form-label required-field">Port</label>
                            <input type="number" class="form-control" id="dbPort">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Password</label>
                            <div class="password-field">
                                <input type="password" class="form-control" id="dbPassword">
                                <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('dbPassword')"></i>
                            </div>
                        </div>
                        <div class="col-md-6" id="serviceField">
                            <label class="form-label">Service Name/Instance</label>
                            <input type="text" class="form-control" id="dbInstance">
                            <small class="form-text text-muted" id="serviceHelp">Service name or instance</small>
                        </div>
                    </div>

                    <!-- Oracle Connection Type Selection -->
                    <div class="row mb-3" id="oracleConnectionType" style="display: none;">
                        <div class="col-md-12">
                            <label class="form-label">Oracle Connection Type</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="oracleConnType" id="useServiceName" value="service" checked>
                                <label class="form-check-label" for="useServiceName">Service Name</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="oracleConnType" id="useSid" value="sid">
                                <label class="form-check-label" for="useSid">SID</label>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isPrimary">
                                <label class="form-check-label" for="isPrimary">
                                    Primary Database
                                </label>
                                <small class="form-text text-muted d-block">Mark as the main database for this environment</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="dbStatus">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="testing">Testing</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info me-2" id="testDbConnectionBtn" onclick="testDatabaseConnection()">
                    <i class="fas fa-plug me-1"></i> Test Connection
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDatabaseConfig()">Save Database</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">Are you sure you want to delete this item?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="deleteWarning">This action cannot be undone.</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Initialize app_runtime_id for environment functionality
    window.app_runtime_id = "{{ app_runtime_id }}";
</script>
<script src="{{ url_for('static', filename='js/env_config_redesigned.js') }}"></script>
{% endblock %}