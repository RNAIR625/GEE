{% extends "base.html" %}

{% block title %}Stations Management{% endblock %}

{% block additional_styles %}
.table thead th {
    background-color: #9b59b6;
    color: white;
    font-weight: 500;
}

.station-card {
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.station-type-badge {
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
}

.station-type-INPUT {
    background-color: #3498db;
    color: white;
}

.station-type-PROCESS {
    background-color: #2ecc71;
    color: white;
}

.station-type-OUTPUT {
    background-color: #e74c3c;
    color: white;
}

.color-preview {
    width: 25px;
    height: 25px;
    display: inline-block;
    border-radius: 50%;
    vertical-align: middle;
    margin-right: 10px;
    border: 1px solid #ddd;
}

.station-icon {
    font-size: 1.2rem;
    margin-right: 10px;
}

.rule-groups-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #eee;
    padding: 10px;
    border-radius: 4px;
}

.mapping-item {
    padding: 8px;
    margin-bottom: 5px;
    border-radius: 4px;
    background-color: #f8f9fa;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.mapping-item:hover {
    background-color: #e9ecef;
}

.sequence-number {
    font-weight: bold;
    color: #6c757d;
    margin-right: 8px;
}
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="card-title mb-0">Stations</h4>
            <button class="btn btn-primary" onclick="openNewStationModal()">
                <i class="fas fa-plus me-2"></i>New Station
            </button>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Station Name</th>
                        <th>Type</th>
                        <th>Icon</th>
                        <th>Color</th>
                        <th>Rule Groups</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="stationTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Station Modal -->
<div class="modal fade" id="stationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add New Station</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="stationForm">
                    <input type="hidden" id="stationId">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Station Name</label>
                            <input type="text" class="form-control" id="stationName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Station Type</label>
                            <select class="form-control" id="stationType">
                                <option value="INPUT">INPUT</option>
                                <option value="PROCESS">PROCESS</option>
                                <option value="OUTPUT">OUTPUT</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Icon</label>
                            <div class="input-group">
                                <span class="input-group-text"><i id="iconPreview" class="fas fa-cog"></i></span>
                                <select class="form-control" id="stationIcon" onchange="updateIconPreview()">
                                    <option value="fa-cog">Cog</option>
                                    <option value="fa-database">Database</option>
                                    <option value="fa-file-alt">File</option>
                                    <option value="fa-envelope">Envelope</option>
                                    <option value="fa-chart-line">Chart</option>
                                    <option value="fa-calculator">Calculator</option>
                                    <option value="fa-check-circle">Checkmark</option>
                                    <option value="fa-exclamation-triangle">Warning</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Color</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <span id="colorPreview" class="color-preview" style="background-color: #9b59b6;"></span>
                                </span>
                                <input type="color" class="form-control form-control-color" id="stationColor" value="#9b59b6" onchange="updateColorPreview()">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="stationDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Assign Rule Groups</label>
                        <div class="row">
                            <div class="col-md-6">
                                <label>Available Rule Groups</label>
                                <div class="rule-groups-list">
                                    <ul id="availableRuleGroups" class="list-group">
                                        <!-- Will be populated dynamically -->
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label>Assigned Rule Groups</label>
                                <div class="rule-groups-list">
                                    <ul id="assignedRuleGroups" class="list-group">
                                        <!-- Will be populated dynamically -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveStation()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this station? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentDeleteId = null;
    let allRuleGroups = [];
    let assignedGroups = [];
    const stationModal = new bootstrap.Modal(document.getElementById('stationModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

    // Load stations when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadStations();
        loadRuleGroups();
    });

    function loadStations() {
        fetch('/get_stations')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('stationTableBody');
                tableBody.innerHTML = '';
                
                data.forEach(station => {
                    const stationTypeClass = `station-type-${station.STATION_TYPE || 'PROCESS'}`;
                    const row = `
                        <tr>
                            <td>${station.STATION_NAME}</td>
                            <td>
                                <span class="station-type-badge ${stationTypeClass}">
                                    ${station.STATION_TYPE || 'PROCESS'}
                                </span>
                            </td>
                            <td>
                                <i class="fas ${station.ICON || 'fa-cog'} station-icon"></i>
                            </td>
                            <td>
                                <span class="color-preview" style="background-color: ${station.COLOR_CODE || '#9b59b6'};"></span>
                                ${station.COLOR_CODE || '#9b59b6'}
                            </td>
                            <td>${getStationRuleGroupsCount(station.STATION_ID)}</td>
                            <td class="action-buttons">
                                <button class="btn btn-info btn-sm" onclick="viewRuleGroups(${station.STATION_ID})">
                                    <i class="fas fa-list"></i>
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="editStation(${station.STATION_ID})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteStation(${station.STATION_ID})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            });
    }
    
    function getStationRuleGroupsCount(stationId) {
        // In a real implementation, this would fetch from the database
        // For now, we'll return a placeholder
        return '0 groups';
    }
    
    function loadRuleGroups() {
        fetch('/get_rule_groups')
            .then(response => response.json())
            .then(data => {
                allRuleGroups = data;
                updateRuleGroupsLists();
            });
    }
    
    function updateRuleGroupsLists() {
        const availableList = document.getElementById('availableRuleGroups');
        const assignedList = document.getElementById('assignedRuleGroups');
        
        // Clear lists
        availableList.innerHTML = '';
        assignedList.innerHTML = '';
        
        // Populate available rule groups (not in assigned list)
        allRuleGroups.forEach(group => {
            const isAssigned = assignedGroups.some(ag => ag.grgId === group.GRG_ID);
            
            if (!isAssigned) {
                availableList.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${group.GROUP_NAME}
                        <button class="btn btn-sm btn-primary" onclick="assignRuleGroup(${group.GRG_ID}, '${group.GROUP_NAME}')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </li>
                `;
            }
        });
        
        // Populate assigned rule groups
        assignedGroups.forEach((group, index) => {
            assignedList.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                        <span class="sequence-number">${index + 1}.</span>
                        ${group.name}
                    </span>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="moveRuleGroup(${index}, 'up')" ${index === 0 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="moveRuleGroup(${index}, 'down')" ${index === assignedGroups.length - 1 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="removeRuleGroup(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </li>
            `;
        });
        
        // If no available groups
        if (availableList.innerHTML === '') {
            availableList.innerHTML = '<li class="list-group-item text-muted">No available rule groups</li>';
        }
        
        // If no assigned groups
        if (assignedList.innerHTML === '') {
            assignedList.innerHTML = '<li class="list-group-item text-muted">No rule groups assigned</li>';
        }
    }
    
    function openNewStationModal() {
        document.getElementById('modalTitle').textContent = 'Add New Station';
        document.getElementById('stationForm').reset();
        document.getElementById('stationId').value = '';
        assignedGroups = [];
        updateRuleGroupsLists();
        updateIconPreview();
        updateColorPreview();
        stationModal.show();
    }
    
    function editStation(stationId) {
        fetch(`/get_stations`)
            .then(response => response.json())
            .then(data => {
                const station = data.find(s => s.STATION_ID === stationId);
                if (station) {
                    document.getElementById('modalTitle').textContent = 'Edit Station';
                    document.getElementById('stationId').value = station.STATION_ID;
                    document.getElementById('stationName').value = station.STATION_NAME;
                    document.getElementById('stationType').value = station.STATION_TYPE || 'PROCESS';
                    document.getElementById('stationIcon').value = station.ICON || 'fa-cog';
                    document.getElementById('stationColor').value = station.COLOR_CODE || '#9b59b6';
                    document.getElementById('stationDescription').value = station.DESCRIPTION || '';
                    
                    updateIconPreview();
                    updateColorPreview();
                    
                    // Fetch assigned rule groups
                    // In a real implementation, this would fetch from the database
                    assignedGroups = [];
                    updateRuleGroupsLists();
                    
                    stationModal.show();
                }
            });
    }
    
    function saveStation() {
        const stationId = document.getElementById('stationId').value;
        const stationName = document.getElementById('stationName').value;
        const stationType = document.getElementById('stationType').value;
        const stationIcon = document.getElementById('stationIcon').value;
        const stationColor = document.getElementById('stationColor').value;
        const stationDescription = document.getElementById('stationDescription').value;
        
        if (!stationName) {
            alert('Station Name is required.');
            return;
        }
        
        const data = {
            stationId: stationId,
            stationName: stationName,
            stationType: stationType,
            icon: stationIcon,
            colorCode: stationColor,
            description: stationDescription,
            ruleGroups: assignedGroups.map((group, index) => ({
                grgId: group.grgId,
                sequence: index + 1,
                isRequired: group.isRequired || false
            }))
        };
        
        const method = stationId ? 'PUT' : 'POST';
        const url = stationId ? '/update_station' : '/add_station';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                stationModal.hide();
                loadStations();
                showToast('Success', result.message);
            } else {
                showToast('Error', result.message, 'error');
            }
        })
        .catch(error => {
            showToast('Error', 'An error occurred while saving the station', 'error');
            console.error('Error:', error);
        });
    }
    
    function deleteStation(stationId) {
        currentDeleteId = stationId;
        deleteModal.show();
    }
    
    function confirmDelete() {
        if (!currentDeleteId) return;
        
        fetch(`/delete_station/${currentDeleteId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                deleteModal.hide();
                loadStations();
                showToast('Success', data.message);
            } else {
                showToast('Error', data.message, 'error');
            }
        })
        .catch(error => {
            showToast('Error', 'An error occurred while deleting the station', 'error');
            console.error('Error:', error);
        });
    }
    
    function viewRuleGroups(stationId) {
        // Placeholder for showing rule groups assigned to a station
        alert('Rule groups viewer will be implemented in a future version.');
    }
    
    function assignRuleGroup(grgId, name) {
        const group = allRuleGroups.find(g => g.GRG_ID === grgId);
        
        if (group) {
            assignedGroups.push({
                grgId: grgId,
                name: name,
                isRequired: false
            });
            
            updateRuleGroupsLists();
        }
    }
    
    function removeRuleGroup(index) {
        assignedGroups.splice(index, 1);
        updateRuleGroupsLists();
    }
    
    function moveRuleGroup(index, direction) {
        if (direction === 'up' && index > 0) {
            // Swap with previous item
            [assignedGroups[index], assignedGroups[index - 1]] = [assignedGroups[index - 1], assignedGroups[index]];
        } else if (direction === 'down' && index < assignedGroups.length - 1) {
            // Swap with next item
            [assignedGroups[index], assignedGroups[index + 1]] = [assignedGroups[index + 1], assignedGroups[index]];
        }
        
        updateRuleGroupsLists();
    }
    
    function updateIconPreview() {
        const icon = document.getElementById('stationIcon').value;
        const preview = document.getElementById('iconPreview');
        
        preview.className = '';
        preview.classList.add('fas', icon);
    }
    
    function updateColorPreview() {
        const color = document.getElementById('stationColor').value;
        const preview = document.getElementById('colorPreview');
        
        preview.style.backgroundColor = color;
    }
</script>
{% endblock %}