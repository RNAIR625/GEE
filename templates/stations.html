{% extends "base.html" %}

{% block title %}Stations Management{% endblock %}

{% block additional_styles %}
.table thead th {
    background-color: #9b59b6;
    color: white;
    font-weight: 500;
}

.station-card {
    margin-bottom: 20px;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
}

.station-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.station-type-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.station-type-INPUT {
    background-color: #3498db;
    color: white;
}

.station-type-PROCESS {
    background-color: #2ecc71;
    color: white;
}

.station-type-OUTPUT {
    background-color: #e74c3c;
    color: white;
}

.color-preview {
    width: 28px;
    height: 28px;
    display: inline-block;
    border-radius: 50%;
    vertical-align: middle;
    margin-right: 10px;
    border: 2px solid #fff;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
}

.station-icon {
    font-size: 1.2rem;
    margin-right: 10px;
    width: 30px;
    height: 30px;
    line-height: 30px;
    text-align: center;
    border-radius: 50%;
    background-color: rgba(155, 89, 182, 0.1);
}

.rule-groups-list {
    max-height: 230px;
    overflow-y: auto;
    border: 1px solid #eee;
    padding: 10px;
    border-radius: 6px;
    background-color: #f8f9fa;
}

.mapping-item {
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 6px;
    background-color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    transition: all 0.2s ease;
}

.mapping-item:hover {
    background-color: #f0f4f8;
}

.sequence-number {
    font-weight: bold;
    color: #9b59b6;
    margin-right: 10px;
    width: 24px;
    height: 24px;
    line-height: 24px;
    text-align: center;
    border-radius: 50%;
    background-color: rgba(155, 89, 182, 0.1);
}

.stations-summary {
    margin-bottom: 20px;
}

.stations-summary-card {
    border-left: 4px solid #9b59b6;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.station-visual {
    width: 100%;
    height: 170px;
    background-color: #f5f0f7;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-bottom: 15px;
}

.station-item {
    transition: all 0.3s ease;
}

.station-item:hover {
    background-color: rgba(155, 89, 182, 0.05);
}

.station-header {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.station-detail-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 5px;
}

.station-rules-badge {
    background-color: #9b59b6;
    color: white;
    font-size: 0.7rem;
    padding: 3px 8px;
    border-radius: 10px;
}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Stations Summary -->
    <div class="row stations-summary">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm stations-summary-card">
                <div class="card-body">
                    <h4 class="card-title mb-4">Station Management</h4>
                    <div class="row">
                        <div class="col-md-4 text-center mb-3">
                            <div class="d-flex align-items-center justify-content-center mb-2">
                                <div class="station-type-badge station-type-INPUT">INPUT</div>
                            </div>
                            <h3 id="inputStationCount">0</h3>
                            <p class="text-muted mb-0">Input Stations</p>
                        </div>
                        <div class="col-md-4 text-center mb-3">
                            <div class="d-flex align-items-center justify-content-center mb-2">
                                <div class="station-type-badge station-type-PROCESS">PROCESS</div>
                            </div>
                            <h3 id="processStationCount">0</h3>
                            <p class="text-muted mb-0">Process Stations</p>
                        </div>
                        <div class="col-md-4 text-center mb-3">
                            <div class="d-flex align-items-center justify-content-center mb-2">
                                <div class="station-type-badge station-type-OUTPUT">OUTPUT</div>
                            </div>
                            <h3 id="outputStationCount">0</h3>
                            <p class="text-muted mb-0">Output Stations</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">Quick Access</h5>
                    <p class="text-muted">Create and manage stations in your workflow</p>
                    <button class="btn btn-primary mt-auto" onclick="openNewStationModal()">
                        <i class="fas fa-plus me-2"></i>New Station
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Station Cards -->
    <div class="row" id="stationCardsContainer">
        <!-- Station cards will be dynamically inserted here -->
    </div>
    
    <!-- Stations Table (Alternate View) -->
    <div class="card border-0 shadow-sm mt-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">All Stations</h5>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-secondary active" id="tableViewBtn">
                    <i class="fas fa-list me-1"></i> Table View
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="cardViewBtn">
                    <i class="fas fa-th-large me-1"></i> Card View
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Station Name</th>
                            <th>Type</th>
                            <th>Icon</th>
                            <th>Color</th>
                            <th>Rule Groups</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stationTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Station Modal -->
<div class="modal fade" id="stationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add New Station</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="stationForm">
                    <input type="hidden" id="stationId">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Station Name</label>
                            <input type="text" class="form-control" id="stationName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Station Type</label>
                            <select class="form-control" id="stationType">
                                <option value="INPUT">INPUT</option>
                                <option value="PROCESS">PROCESS</option>
                                <option value="OUTPUT">OUTPUT</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Icon</label>
                            <div class="input-group">
                                <span class="input-group-text"><i id="iconPreview" class="fas fa-cog"></i></span>
                                <select class="form-control" id="stationIcon" onchange="updateIconPreview()">
                                    <option value="fa-cog">Cog</option>
                                    <option value="fa-database">Database</option>
                                    <option value="fa-file-alt">File</option>
                                    <option value="fa-envelope">Envelope</option>
                                    <option value="fa-chart-line">Chart</option>
                                    <option value="fa-calculator">Calculator</option>
                                    <option value="fa-check-circle">Checkmark</option>
                                    <option value="fa-exclamation-triangle">Warning</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Color</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <span id="colorPreview" class="color-preview" style="background-color: #9b59b6;"></span>
                                </span>
                                <input type="color" class="form-control form-control-color w-100" id="stationColor" value="#9b59b6" onchange="updateColorPreview()">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="stationDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Assign Rule Groups</label>
                        <div class="row">
                            <div class="col-md-6">
                                <label>Available Rule Groups</label>
                                <div class="rule-groups-list">
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control form-control-sm" placeholder="Search rule groups" id="ruleGroupSearchInput">
                                        <button class="btn btn-sm btn-outline-secondary" type="button">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                    <ul id="availableRuleGroups" class="list-group list-group-flush">
                                        <!-- Will be populated dynamically -->
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label>Assigned Rule Groups</label>
                                <div class="rule-groups-list">
                                    <ul id="assignedRuleGroups" class="list-group list-group-flush">
                                        <!-- Will be populated dynamically -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveStation()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this station? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Rule Groups Viewer Modal -->
<div class="modal fade" id="ruleGroupsViewerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rule Groups for <span id="stationNameInViewer"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Sequence</th>
                                <th>Rule Group</th>
                                <th>Required</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="ruleGroupsViewerBody">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Variables for managing state
    let currentDeleteId = null;
    let allRuleGroups = [];
    let assignedGroups = [];
    const stationModal = new bootstrap.Modal(document.getElementById('stationModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const ruleGroupsViewerModal = new bootstrap.Modal(document.getElementById('ruleGroupsViewerModal'));

    // Mock data for stations and rule groups
    const mockStations = [
        {
            STATION_ID: 1,
            STATION_NAME: 'Data Input',
            STATION_TYPE: 'INPUT',
            ICON: 'fa-file-alt',
            COLOR_CODE: '#3498db',
            DESCRIPTION: 'Initial data entry station'
        },
        {
            STATION_ID: 2,
            STATION_NAME: 'Data Processing',
            STATION_TYPE: 'PROCESS',
            ICON: 'fa-cog',
            COLOR_CODE: '#2ecc71',
            DESCRIPTION: 'Main data transformation and processing'
        },
        {
            STATION_ID: 3,
            STATION_NAME: 'Report Generation',
            STATION_TYPE: 'OUTPUT',
            ICON: 'fa-chart-line',
            COLOR_CODE: '#e74c3c',
            DESCRIPTION: 'Final report generation and export'
        }
    ];

    const mockRuleGroups = [
        { GRG_ID: 1, GROUP_NAME: 'Validation Rules', DESCRIPTION: 'Basic data validation rules' },
        { GRG_ID: 2, GROUP_NAME: 'Business Logic', DESCRIPTION: 'Core business logic rules' },
        { GRG_ID: 3, GROUP_NAME: 'Formatting Rules', DESCRIPTION: 'Output formatting rules' },
        { GRG_ID: 4, GROUP_NAME: 'Security Rules', DESCRIPTION: 'Security and access control rules' }
    ];

    // Load stations and rule groups when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadStations();
        loadRuleGroups();
        
        // Set up view toggle buttons
        document.getElementById('tableViewBtn').addEventListener('click', function() {
            document.getElementById('tableViewBtn').classList.add('active');
            document.getElementById('cardViewBtn').classList.remove('active');
            document.getElementById('stationCardsContainer').style.display = 'none';
            document.querySelector('.table-responsive').style.display = 'block';
        });
        
        document.getElementById('cardViewBtn').addEventListener('click', function() {
            document.getElementById('cardViewBtn').classList.add('active');
            document.getElementById('tableViewBtn').classList.remove('active');
            document.getElementById('stationCardsContainer').style.display = 'flex';
            document.querySelector('.table-responsive').style.display = 'none';
        });
        
        // Trigger table view by default
        document.getElementById('tableViewBtn').click();
        
        // Set up rule group search
        document.getElementById('ruleGroupSearchInput').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const availableGroups = document.querySelectorAll('#availableRuleGroups li');
            
            availableGroups.forEach(group => {
                const text = group.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    group.style.display = '';
                } else {
                    group.style.display = 'none';
                }
            });
        });
    });

    function loadStations() {
        // Use the mock data directly
        updateStationCounters(mockStations);
        renderStationTable(mockStations);
        renderStationCards(mockStations);
    }
    
    function updateStationCounters(stations) {
        let inputCount = 0;
        let processCount = 0;
        let outputCount = 0;
        
        stations.forEach(station => {
            const type = station.STATION_TYPE || 'PROCESS';
            if (type === 'INPUT') inputCount++;
            else if (type === 'PROCESS') processCount++;
            else if (type === 'OUTPUT') outputCount++;
        });
        
        document.getElementById('inputStationCount').textContent = inputCount;
        document.getElementById('processStationCount').textContent = processCount;
        document.getElementById('outputStationCount').textContent = outputCount;
    }
    
    function renderStationTable(stations) {
        const tableBody = document.getElementById('stationTableBody');
        tableBody.innerHTML = '';
        
        stations.forEach(station => {
            const stationTypeClass = `station-type-${station.STATION_TYPE || 'PROCESS'}`;
            const row = `
                <tr class="station-item">
                    <td>
                        <div class="station-header">
                            <span class="color-preview" style="background-color: ${station.COLOR_CODE || '#9b59b6'};"></span>
                            <span>${station.STATION_NAME}</span>
                        </div>
                    </td>
                    <td>
                        <span class="station-type-badge ${stationTypeClass}">
                            ${station.STATION_TYPE || 'PROCESS'}
                        </span>
                    </td>
                    <td>
                        <i class="fas ${station.ICON || 'fa-cog'} station-icon"></i>
                    </td>
                    <td>
                        <code>${station.COLOR_CODE || '#9b59b6'}</code>
                    </td>
                    <td>
                        <span class="station-rules-badge">
                            ${getStationRuleGroupsCount(station.STATION_ID)} groups
                        </span>
                    </td>
                    <td class="action-buttons">
                        <button class="btn btn-info btn-sm" onclick="viewRuleGroups(${station.STATION_ID}, '${station.STATION_NAME}')">
                            <i class="fas fa-list"></i>
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="editStation(${station.STATION_ID})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteStation(${station.STATION_ID})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
        
        // If no stations
        if (stations.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <div class="text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            No stations found. Create your first station to get started.
                        </div>
                    </td>
                </tr>
            `;
        }
    }
    
    function renderStationCards(stations) {
        const cardsContainer = document.getElementById('stationCardsContainer');
        cardsContainer.innerHTML = '';
        
        stations.forEach(station => {
            const stationTypeClass = `station-type-${station.STATION_TYPE || 'PROCESS'}`;
            const card = `
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card station-card border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0">${station.STATION_NAME}</h5>
                                <span class="station-type-badge ${stationTypeClass}">
                                    ${station.STATION_TYPE || 'PROCESS'}
                                </span>
                            </div>
                            
                            <div class="station-visual" style="background-color: ${lightenColor(station.COLOR_CODE || '#9b59b6', 0.9)}">
                                <i class="fas ${station.ICON || 'fa-cog'} mb-2" style="font-size: 48px; color: ${station.COLOR_CODE || '#9b59b6'};"></i>
                                <div class="badge bg-light text-dark">
                                    ${getStationRuleGroupsCount(station.STATION_ID)} Rule Groups
                                </div>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="station-detail-label">Color</div>
                                    <div>
                                        <span class="color-preview" style="background-color: ${station.COLOR_CODE || '#9b59b6'};"></span>
                                        <code>${station.COLOR_CODE || '#9b59b6'}</code>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="station-detail-label">Icon</div>
                                    <div>
                                        <i class="fas ${station.ICON || 'fa-cog'} station-icon"></i>
                                        ${formatIconName(station.ICON || 'fa-cog')}
                                    </div>
                                </div>
                            </div>
                            
                            <p class="text-muted mt-3">${station.DESCRIPTION || 'No description provided.'}</p>
                            
                            <div class="d-flex justify-content-between mt-3">
                                <button class="btn btn-sm btn-info" onclick="viewRuleGroups(${station.STATION_ID}, '${station.STATION_NAME}')">
                                    <i class="fas fa-list me-1"></i> Rules
                                </button>
                                <div>
                                    <button class="btn btn-sm btn-warning" onclick="editStation(${station.STATION_ID})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger ms-1" onclick="deleteStation(${station.STATION_ID})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            cardsContainer.innerHTML += card;
        });
        
        // If no stations
        if (stations.length === 0) {
            cardsContainer.innerHTML = `
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-desktop mb-3" style="font-size: 48px; color: #ccc;"></i>
                            <h5>No Stations Found</h5>
                            <p class="text-muted">Create your first station to get started.</p>
                            <button class="btn btn-primary" onclick="openNewStationModal()">
                                <i class="fas fa-plus me-2"></i>Create Station
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    function getStationRuleGroupsCount(stationId) {
        // Return a random number between 0 and 5
        return Math.floor(Math.random() * 5);
    }
    
    function loadRuleGroups() {
        // Use mock data directly
        allRuleGroups = mockRuleGroups;
        updateRuleGroupsLists();
    }
    
    function updateRuleGroupsLists() {
        const availableList = document.getElementById('availableRuleGroups');
        const assignedList = document.getElementById('assignedRuleGroups');
        
        // Clear lists
        availableList.innerHTML = '';
        assignedList.innerHTML = '';
        
        // Populate available rule groups (not in assigned list)
        allRuleGroups.forEach(group => {
            const isAssigned = assignedGroups.some(ag => ag.grgId === group.GRG_ID);
            
            if (!isAssigned) {
                availableList.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center border-0 py-2">
                        <div>
                            <span>${group.GROUP_NAME}</span>
                            <small class="text-muted d-block">${group.DESCRIPTION || ''}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="assignRuleGroup(${group.GRG_ID}, '${group.GROUP_NAME}', '${group.DESCRIPTION || ''}')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </li>
                `;
            }
        });
        
        // Populate assigned rule groups
        assignedGroups.forEach((group, index) => {
            assignedList.innerHTML += `
                <li class="list-group-item border-0 py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <span class="sequence-number">${index + 1}</span>
                            <div>
                                <span>${group.name}</span>
                                <small class="text-muted d-block">${group.description || ''}</small>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="moveRuleGroup(${index}, 'up')" ${index === 0 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="moveRuleGroup(${index}, 'down')" ${index === assignedGroups.length - 1 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeRuleGroup(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="isRequired-${index}" 
                               ${group.isRequired ? 'checked' : ''} onchange="toggleRequired(${index})">
                        <label class="form-check-label" for="isRequired-${index}">
                            Required for station processing
                        </label>
                    </div>
                </li>
            `;
        });
        
        // If no available groups
        if (availableList.innerHTML === '') {
            availableList.innerHTML = '<li class="list-group-item border-0 text-center text-muted py-3">No available rule groups</li>';
        }
        
        // If no assigned groups
        if (assignedList.innerHTML === '') {
            assignedList.innerHTML = '<li class="list-group-item border-0 text-center text-muted py-3">No rule groups assigned</li>';
        }
    }
    
    function openNewStationModal() {
        document.getElementById('modalTitle').textContent = 'Add New Station';
        document.getElementById('stationForm').reset();
        document.getElementById('stationId').value = '';
        assignedGroups = [];
        updateRuleGroupsLists();
        updateIconPreview();
        updateColorPreview();
        stationModal.show();
    }
    
    function editStation(stationId) {
        // Find the station in our mock data
        const station = mockStations.find(s => s.STATION_ID === stationId);
        
        if (station) {
            document.getElementById('modalTitle').textContent = 'Edit Station';
            document.getElementById('stationId').value = station.STATION_ID;
            document.getElementById('stationName').value = station.STATION_NAME;
            document.getElementById('stationType').value = station.STATION_TYPE || 'PROCESS';
            document.getElementById('stationIcon').value = station.ICON || 'fa-cog';
            document.getElementById('stationColor').value = station.COLOR_CODE || '#9b59b6';
            document.getElementById('stationDescription').value = station.DESCRIPTION || '';
            
            updateIconPreview();
            updateColorPreview();
            
            // Mock assigned rule groups
            assignedGroups = stationId % 2 === 0
                ? [
                    { grgId: 1, name: 'Validation Rules', description: 'Basic data validation rules', isRequired: true },
                    { grgId: 3, name: 'Formatting Rules', description: 'Output formatting rules', isRequired: false }
                  ]
                : [
                    { grgId: 2, name: 'Business Logic', description: 'Core business logic rules', isRequired: true }
                  ];
            
            updateRuleGroupsLists();
            stationModal.show();
        } else {
            showToast('Error', 'Station not found', 'error');
        }
    }
    
    function saveStation() {
        const stationId = parseInt(document.getElementById('stationId').value);
        const stationName = document.getElementById('stationName').value;
        const stationType = document.getElementById('stationType').value;
        const stationIcon = document.getElementById('stationIcon').value;
        const stationColor = document.getElementById('stationColor').value;
        const stationDescription = document.getElementById('stationDescription').value;
        
        if (!stationName) {
            showToast('Error', 'Station Name is required.', 'error');
            return;
        }
        
        // Create a new station object
        const newStation = {
            STATION_ID: stationId || Math.floor(Math.random() * 1000),
            STATION_NAME: stationName,
            STATION_TYPE: stationType,
            ICON: stationIcon,
            COLOR_CODE: stationColor,
            DESCRIPTION: stationDescription
        };
        
        // Update or add the station in our mock data
        if (stationId) {
            // Update existing station
            const index = mockStations.findIndex(s => s.STATION_ID === stationId);
            if (index !== -1) {
                mockStations[index] = newStation;
            }
        } else {
            // Add new station
            mockStations.push(newStation);
        }
        
        stationModal.hide();
        
        // Refresh UI
        loadStations();
        showToast('Success', stationId ? 'Station updated successfully!' : 'Station created successfully!');
    }
    
    function deleteStation(stationId) {
        currentDeleteId = stationId;
        deleteModal.show();
    }
    
    function confirmDelete() {
        if (!currentDeleteId) return;
        
        // Remove the station from our mock data
        const index = mockStations.findIndex(s => s.STATION_ID === currentDeleteId);
        if (index !== -1) {
            mockStations.splice(index, 1);
        }
        
        deleteModal.hide();
        
        // Refresh UI
        loadStations();
        showToast('Success', 'Station deleted successfully!');
    }
    
    function viewRuleGroups(stationId, stationName) {
        document.getElementById('stationNameInViewer').textContent = stationName;
        const ruleGroupsViewerBody = document.getElementById('ruleGroupsViewerBody');
        ruleGroupsViewerBody.innerHTML = '';
        
        // Get mock rule groups for this station
        const mockRuleGroups = stationId % 2 === 0
            ? [
                { sequence: 1, name: 'Validation Rules', isRequired: true, description: 'Basic data validation rules' },
                { sequence: 2, name: 'Formatting Rules', isRequired: false, description: 'Output formatting rules' }
              ]
            : [
                { sequence: 1, name: 'Business Logic', isRequired: true, description: 'Core business logic rules' }
              ];
        
        mockRuleGroups.forEach(group => {
            const row = `
                <tr>
                    <td>${group.sequence}</td>
                    <td>${group.name}</td>
                    <td>
                        <span class="badge ${group.isRequired ? 'bg-success' : 'bg-secondary'}">
                            ${group.isRequired ? 'Required' : 'Optional'}
                        </span>
                    </td>
                    <td>${group.description || ''}</td>
                </tr>
            `;
            ruleGroupsViewerBody.innerHTML += row;
        });
        
        // If no rule groups
        if (mockRuleGroups.length === 0) {
            ruleGroupsViewerBody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-3">
                        <div class="text-muted">No rule groups assigned to this station</div>
                    </td>
                </tr>
            `;
        }
        
        ruleGroupsViewerModal.show();
    }
    
    function assignRuleGroup(grgId, name, description) {
        const group = allRuleGroups.find(g => g.GRG_ID === grgId);
        
        if (group) {
            assignedGroups.push({
                grgId: grgId,
                name: name,
                description: description,
                isRequired: false
            });
            
            updateRuleGroupsLists();
        }
    }
    
    function removeRuleGroup(index) {
        assignedGroups.splice(index, 1);
        updateRuleGroupsLists();
    }
    
    function moveRuleGroup(index, direction) {
        if (direction === 'up' && index > 0) {
            // Swap with previous item
            [assignedGroups[index], assignedGroups[index - 1]] = [assignedGroups[index - 1], assignedGroups[index]];
        } else if (direction === 'down' && index < assignedGroups.length - 1) {
            // Swap with next item
            [assignedGroups[index], assignedGroups[index + 1]] = [assignedGroups[index + 1], assignedGroups[index]];
        }
        
        updateRuleGroupsLists();
    }
    
    function toggleRequired(index) {
        if (index >= 0 && index < assignedGroups.length) {
            assignedGroups[index].isRequired = document.getElementById(`isRequired-${index}`).checked;
        }
    }
    
    function updateIconPreview() {
        const icon = document.getElementById('stationIcon').value;
        const preview = document.getElementById('iconPreview');
        
        preview.className = '';
        preview.classList.add('fas', icon);
    }
    
    function updateColorPreview() {
        const color = document.getElementById('stationColor').value;
        const preview = document.getElementById('colorPreview');
        
        preview.style.backgroundColor = color;
    }
    
    function formatIconName(iconClass) {
        // Convert fa-icon-name to Icon Name
        return iconClass
            .replace('fa-', '')
            .split('-')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }
    
    function lightenColor(color, factor) {
        // Convert hex to RGB
        let r, g, b;
        if (color.startsWith('#')) {
            const hex = color.substring(1);
            r = parseInt(hex.substring(0, 2), 16);
            g = parseInt(hex.substring(2, 4), 16);
            b = parseInt(hex.substring(4, 6), 16);
        } else {
            // Default color if invalid
            r = 155; g = 89; b = 182; // #9b59b6
        }
        
        // Lighten
        r = Math.floor(r + (255 - r) * factor);
        g = Math.floor(g + (255 - g) * factor);
        b = Math.floor(b + (255 - b) * factor);
        
        // Convert back to hex
        return `rgb(${r}, ${g}, ${b})`;
    }
    
    // Simple toast notification function
    function showToast(title, message, type = 'success') {
        // Create bootstrap toast or alert
        const toastEl = document.createElement('div');
        toastEl.className = `toast position-fixed top-0 end-0 m-3 bg-${type === 'success' ? 'success' : 'danger'} text-white`;
        toastEl.setAttribute('role', 'alert');
        toastEl.innerHTML = `
            <div class="toast-header">
                <strong class="me-auto">${title}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">${message}</div>
        `;
        
        document.body.appendChild(toastEl);
        
        // Use Bootstrap toast if available
        if (typeof bootstrap !== 'undefined') {
            const bsToast = new bootstrap.Toast(toastEl);
            bsToast.show();
            
            // Auto-remove after being hidden
            toastEl.addEventListener('hidden.bs.toast', () => {
                document.body.removeChild(toastEl);
            });
        } else {
            // Simple fallback
            toastEl.style.display = 'block';
            setTimeout(() => {
                toastEl.style.display = 'none';
                document.body.removeChild(toastEl);
            }, 3000);
        }
    }
</script>
{% endblock %}