{% extends "base.html" %}

{% block title %}GEE Flow Manager - Dashboard{% endblock %}

{% block additional_styles %}
.stat-card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border-radius: 0.5rem;
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.stat-card .card-body {
    display: flex;
    align-items: center;
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    margin-right: 1rem;
}

.stat-details {
    flex-grow: 1;
}

.stat-title {
    font-size: 1rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
}

.stat-value {
    font-size: 2rem;
    font-weight: 600;
    margin-bottom: 0;
}

.recent-activity-card {
    border: none;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    height: 100%;
}

.activity-item {
    border-left: 3px solid #e9ecef;
    padding: 0.75rem 0 0.75rem 1rem;
    position: relative;
}

.activity-item:not(:last-child) {
    margin-bottom: 0.5rem;
}

.activity-item::before {
    content: '';
    position: absolute;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #3498db;
    left: -7px;
    top: 1.2rem;
}

.activity-time {
    font-size: 0.75rem;
    color: #6c757d;
}

.activity-text {
    margin-bottom: 0;
}

.activity-item.create::before {
    background-color: #2ecc71;
}

.activity-item.update::before {
    background-color: #f39c12;
}

.activity-item.delete::before {
    background-color: #e74c3c;
}

.activity-item.execute::before {
    background-color: #9b59b6;
}

.quick-actions .list-group-item {
    border-left: none;
    border-right: none;
    padding: 0.75rem 1rem;
}

.quick-actions .list-group-item:first-child {
    border-top: none;
}

.quick-actions .list-group-item:last-child {
    border-bottom: none;
}

.quick-actions .list-group-item-action {
    display: flex;
    align-items: center;
}

.action-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.action-details {
    flex-grow: 1;
}

.action-title {
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.action-description {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 0;
}

.flow-card {
    border: none;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    margin-bottom: 1rem;
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.flow-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.flow-header {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #e9ecef;
}

.flow-title {
    font-weight: 600;
    margin-bottom: 0;
    flex-grow: 1;
}

.flow-status {
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
}

.flow-status.draft {
    background-color: #e9ecef;
    color: #6c757d;
}

.flow-status.active {
    background-color: #d4edda;
    color: #155724;
}

.flow-status.archived {
    background-color: #f8d7da;
    color: #721c24;
}

.flow-body {
    padding: 1rem;
}

.flow-description {
    color: #6c757d;
    margin-bottom: 0.5rem;
}

.flow-meta {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 0;
}

.flow-actions {
    padding: 1rem;
    border-top: 1px solid #e9ecef;
    display: flex;
    gap: 0.5rem;
}
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Dashboard</h2>
        <div>
            <button class="btn btn-primary" onclick="window.location.href='{{ url_for('flow_designer') }}'">
                <i class="fas fa-plus me-2"></i>Create New Flow
            </button>
        </div>
    </div>
    
    <!-- Stats Row -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                        <i class="fas fa-sitemap"></i>
                    </div>
                    <div class="stat-details">
                        <h6 class="stat-title">Active Flows</h6>
                        <p class="stat-value" id="activeFlowCount">0</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="stat-icon bg-success bg-opacity-10 text-success">
                        <i class="fas fa-object-group"></i>
                    </div>
                    <div class="stat-details">
                        <h6 class="stat-title">Rule Groups</h6>
                        <p class="stat-value" id="ruleGroupCount">0</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                        <i class="fas fa-project-diagram"></i>
                    </div>
                    <div class="stat-details">
                        <h6 class="stat-title">Stations</h6>
                        <p class="stat-value" id="stationCount">0</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="stat-icon bg-info bg-opacity-10 text-info">
                        <i class="fas fa-list-alt"></i>
                    </div>
                    <div class="stat-details">
                        <h6 class="stat-title">Fields</h6>
                        <p class="stat-value" id="fieldCount">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Row -->
    <div class="row">
        <!-- Recent Flows -->
        <div class="col-lg-8 mb-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Recent Flows</h5>
                </div>
                <div class="card-body" id="recentFlowsContainer">
                    <div class="text-center py-5" id="noFlowsMessage">
                        <i class="fas fa-sitemap fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No flows created yet. Click the "Create New Flow" button to get started.</p>
                    </div>
                    <!-- Flow cards will be populated here -->
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="card recent-activity-card">
                <div class="card-header">
                    <h5 class="mb-0">Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div id="activityList">
                        <div class="activity-item create">
                            <div class="activity-time">Today, 10:15 AM</div>
                            <p class="activity-text"><strong>John Doe</strong> created a new flow <strong>"Customer Onboarding"</strong></p>
                        </div>
                        <div class="activity-item update">
                            <div class="activity-time">Yesterday, 2:30 PM</div>
                            <p class="activity-text"><strong>Jane Smith</strong> updated rule group <strong>"Validation Rules"</strong></p>
                        </div>
                        <div class="activity-item execute">
                            <div class="activity-time">Mar 2, 2025, 9:45 AM</div>
                            <p class="activity-text"><strong>System</strong> executed flow <strong>"Data Migration"</strong> successfully</p>
                        </div>
                        <div class="activity-item update">
                            <div class="activity-time">Mar 1, 2025, 11:20 AM</div>
                            <p class="activity-text"><strong>John Doe</strong> added new station <strong>"Payment Processing"</strong></p>
                        </div>
                        <div class="activity-item delete">
                            <div class="activity-time">Feb 28, 2025, 3:15 PM</div>
                            <p class="activity-text"><strong>Jane Smith</strong> deleted field <strong>"Old Address"</strong></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="list-group list-group-flush quick-actions">
                    <a href="{{ url_for('class_page') }}" class="list-group-item list-group-item-action">
                        <div class="action-icon bg-primary bg-opacity-10 text-primary">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="action-details">
                            <h6 class="action-title">Manage Classes</h6>
                            <p class="action-description">Create and organize field classes</p>
                        </div>
                    </a>
                    <a href="{{ url_for('fields') }}" class="list-group-item list-group-item-action">
                        <div class="action-icon bg-info bg-opacity-10 text-info">
                            <i class="fas fa-list-alt"></i>
                        </div>
                        <div class="action-details">
                            <h6 class="action-title">Manage Fields</h6>
                            <p class="action-description">Define data fields and properties</p>
                        </div>
                    </a>
                    <a href="{{ url_for('function') }}" class="list-group-item list-group-item-action">
                        <div class="action-icon bg-secondary bg-opacity-10 text-secondary">
                            <i class="fas fa-code"></i>
                        </div>
                        <div class="action-details">
                            <h6 class="action-title">Manage Functions</h6>
                            <p class="action-description">Create function definitions and parameters</p>
                        </div>
                    </a>
                    <a href="{{ url_for('rule_groups') }}" class="list-group-item list-group-item-action">
                        <div class="action-icon bg-success bg-opacity-10 text-success">
                            <i class="fas fa-object-group"></i>
                        </div>
                        <div class="action-details">
                            <h6 class="action-title">Manage Rule Groups</h6>
                            <p class="action-description">Organize rules into logical groups</p>
                        </div>
                    </a>
                    <a href="{{ url_for('stations') }}" class="list-group-item list-group-item-action">
                        <div class="action-icon bg-warning bg-opacity-10 text-warning">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <div class="action-details">
                            <h6 class="action-title">Manage Stations</h6>
                            <p class="action-description">Create processing stations for your flows</p>
                        </div>
                    </a>
                </div>
            </div>
            
            <!-- System Status -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">System Status</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Database</h6>
                        <div class="d-flex align-items-center">
                            <div class="me-2 text-success"><i class="fas fa-circle"></i></div>
                            <div>
                                <div class="fw-medium">Connected</div>
                                <small class="text-muted">SQLite - SLEP.db</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Last Backup</h6>
                        <div class="d-flex align-items-center">
                            <div class="me-2 text-success"><i class="fas fa-check-circle"></i></div>
                            <div>
                                <div class="fw-medium">Today, 03:00 AM</div>
                                <small class="text-muted">Automatic daily backup</small>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h6 class="text-muted mb-2">Flow Executions</h6>
                        <div class="d-flex align-items-center">
                            <div class="me-2 text-success"><i class="fas fa-check-circle"></i></div>
                            <div>
                                <div class="fw-medium">All Systems Operational</div>
                                <small class="text-muted">No recent errors detected</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
        loadRecentFlows();
    });
    
    function loadDashboardData() {
        // In a real implementation, this would fetch stats from the server
        // For now, we'll use placeholder data
        
        // Fetch flow count
        fetch('/get_flows')
            .then(response => response.json())
            .then(data => {
                const activeFlows = data.filter(flow => flow.STATUS === 'ACTIVE').length;
                document.getElementById('activeFlowCount').textContent = activeFlows;
            })
            .catch(error => {
                console.error('Error loading flows:', error);
                document.getElementById('activeFlowCount').textContent = '0';
            });
        
        // Fetch rule group count
        fetch('/get_rule_groups')
            .then(response => response.json())
            .then(data => {
                document.getElementById('ruleGroupCount').textContent = data.length;
            })
            .catch(error => {
                console.error('Error loading rule groups:', error);
                document.getElementById('ruleGroupCount').textContent = '0';
            });
        
        // Fetch station count
        fetch('/get_stations')
            .then(response => response.json())
            .then(data => {
                document.getElementById('stationCount').textContent = data.length;
            })
            .catch(error => {
                console.error('Error loading stations:', error);
                document.getElementById('stationCount').textContent = '0';
            });
        
        // Fetch field count
        fetch('/get_fields')
            .then(response => response.json())
            .then(data => {
                document.getElementById('fieldCount').textContent = data.length;
            })
            .catch(error => {
                console.error('Error loading fields:', error);
                document.getElementById('fieldCount').textContent = '0';
            });
    }
    
    function loadRecentFlows() {
        fetch('/get_flows')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('recentFlowsContainer');
                const noFlowsMessage = document.getElementById('noFlowsMessage');
                
                if (data.length === 0) {
                    noFlowsMessage.classList.remove('d-none');
                    return;
                }
                
                noFlowsMessage.classList.add('d-none');
                
                // Sort flows by create date (newest first)
                data.sort((a, b) => {
                    const dateA = new Date(a.CREATE_DATE);
                    const dateB = new Date(b.CREATE_DATE);
                    return dateB - dateA;
                });
                
                // Take only the most recent 5 flows
                const recentFlows = data.slice(0, 5);
                
                // Clear container
                container.innerHTML = '';
                
                // Add flow cards
                recentFlows.forEach(flow => {
                    const statusClass = flow.STATUS === 'ACTIVE' ? 'active' : 
                                      (flow.STATUS === 'ARCHIVED' ? 'archived' : 'draft');
                    
                    const createDate = new Date(flow.CREATE_DATE);
                    const formattedDate = createDate.toLocaleDateString();
                    
                    const card = `
                        <div class="flow-card">
                            <div class="flow-header">
                                <h5 class="flow-title">${flow.FLOW_NAME}</h5>
                                <span class="flow-status ${statusClass}">${flow.STATUS}</span>
                            </div>
                            <div class="flow-body">
                                <p class="flow-description">${flow.DESCRIPTION || 'No description provided'}</p>
                                <p class="flow-meta">
                                    <span class="me-3"><i class="far fa-calendar-alt me-1"></i> Created: ${formattedDate}</span>
                                    <span><i class="fas fa-code-branch me-1"></i> Version: ${flow.VERSION}</span>
                                </p>
                            </div>
                            <div class="flow-actions">
                                <a href="/flow_designer?flow_id=${flow.FLOW_ID}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-edit me-1"></i> Edit
                                </a>
                                <button class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-play me-1"></i> Execute
                                </button>
                                <button class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-clone me-1"></i> Clone
                                </button>
                            </div>
                        </div>
                    `;
                    
                    container.innerHTML += card;
                });
            })
            .catch(error => {
                console.error('Error loading flows:', error);
                const container = document.getElementById('recentFlowsContainer');
                const noFlowsMessage = document.getElementById('noFlowsMessage');
                
                noFlowsMessage.classList.remove('d-none');
                noFlowsMessage.innerHTML = `
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <p class="text-muted">Error loading flows. Please try refreshing the page.</p>
                `;
            });
    }
</script>
{% endblock %}
